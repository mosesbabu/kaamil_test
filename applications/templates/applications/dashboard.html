<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMA Portal – Application Management</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* ============================================ */
        /* DESIGN SYSTEM: ReadyKids Professional Registration                                */
        /* ============================================ */
        :root {
            --rk-primary: #0f5132;
            --rk-primary-light: #198754;
            --rk-primary-dark: #0a3622;
            --rk-accent: #0d6efd;
            --rk-accent-light: #6ea8fe;
            
            --status-complete: #198754;
            --status-pending: #fd7e14;
            --status-blocked: #dc3545;
            --status-info: #0dcaf0;
            --status-review: #6f42c1;
            --status-draft: #6c757d;
            
            --risk-high: #dc3545;
            --risk-medium: #fd7e14;
            --risk-low: #198754;
            
            --bg-app: #f8f9fa;
            --bg-card: #ffffff;
            --bg-subtle: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-default: #dee2e6;
            --border-subtle: #e9ecef;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -1px rgba(0,0,0,0.04);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -2px rgba(0,0,0,0.04);
            --shadow-focus: 0 0 0 3px rgba(13,110,253,0.25);
            
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-app); color: var(--text-primary); }

        /* ============================================ */
        /* LAYOUT                                       */
        /* ============================================ */
        .app-container { display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; }

        /* SIDEBAR */
        .sidebar {
            background: var(--rk-primary-dark);
            color: #e6edf3;
            padding: var(--space-lg);
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }
        .sidebar-brand { display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-xl); padding-bottom: var(--space-lg); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-brand-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--rk-primary), var(--rk-accent)); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem; color: white; }
        .sidebar-brand-text { font-weight: 700; font-size: 1rem; line-height: 1.3; }
        .sidebar-brand-text span { display: block; font-size: 0.7rem; font-weight: 400; opacity: 0.6; }

        .sidebar-nav { list-style: none; }
        .sidebar-nav-link {
            display: flex; align-items: center; gap: var(--space-md);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            color: rgba(230,237,243,0.7);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            margin-bottom: 2px;
        }
        .sidebar-nav-link:hover { color: white; background: rgba(255,255,255,0.1); }
        .sidebar-nav-link.active { color: #ffffff; background: var(--rk-primary-light); font-weight: 500; }
        .sidebar-nav-link svg { width: 18px; height: 18px; flex-shrink: 0; }
        .sidebar-nav-badge { margin-left: auto; background: var(--risk-high); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 600; }
        .sidebar-nav-badge.info { background: var(--status-info); color: #000; }
        .sidebar-nav-badge.warning { background: var(--status-pending); color: #000; }

        .sidebar-section-title { font-size: 0.65rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: rgba(255,255,255,0.3); padding: var(--space-md) var(--space-md) var(--space-xs); }

        .sidebar-stats { margin-top: auto; padding-top: var(--space-lg); border-top: 1px solid rgba(255,255,255,0.1); }
        .sidebar-stat { display: flex; justify-content: space-between; align-items: center; padding: var(--space-xs) 0; font-size: 0.8rem; color: rgba(255,255,255,0.5); }
        .sidebar-stat-value { font-weight: 600; color: rgba(255,255,255,0.8); }

        /* MAIN CONTENT */
        .main-content { padding: var(--space-xl); overflow-y: auto; }
        .main-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-xl); }
        .main-title { font-size: 1.5rem; font-weight: 700; margin-bottom: var(--space-xs); }
        .main-subtitle { color: var(--text-secondary); font-size: 0.9rem; }
        .header-actions { display: flex; gap: var(--space-sm); }

        /* BUTTONS */
        .btn {
            display: inline-flex; align-items: center; gap: var(--space-xs);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            font-size: 0.85rem; font-weight: 600;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.15s ease;
            text-decoration: none;
        }
        .btn svg { width: 16px; height: 16px; }
        .btn-primary { background: var(--rk-primary); color: white; }
        .btn-primary:hover { background: var(--rk-primary-dark); }
        .btn-secondary { background: var(--bg-card); border-color: var(--border-default); color: var(--text-primary); }
        .btn-secondary:hover { background: var(--bg-subtle); }
        .btn-outline { background: transparent; border-color: var(--border-default); color: var(--text-secondary); }
        .btn-outline:hover { background: var(--bg-subtle); color: var(--text-primary); }
        .btn-sm { padding: var(--space-xs) var(--space-sm); font-size: 0.8rem; }

        /* STATS GRID */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-md); margin-bottom: var(--space-xl); }
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            position: relative;
            overflow: hidden;
        }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; }
        .stat-card.info::before { background: var(--status-info); }
        .stat-card.success::before { background: var(--status-complete); }
        .stat-card.warning::before { background: var(--status-pending); }
        .stat-card.urgent::before { background: var(--status-blocked); }
        .stat-card-value { font-size: 2rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; line-height: 1; margin-bottom: var(--space-xs); }
        .stat-card-label { font-size: 0.8rem; color: var(--text-secondary); font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; }
        .stat-card-trend { position: absolute; top: var(--space-md); right: var(--space-md); font-size: 0.75rem; padding: 2px 8px; border-radius: 20px; font-weight: 500; }
        .stat-card-trend.up { background: #dafbe1; color: #0f5132; }
        .stat-card-trend.down { background: #ffebe9; color: #842029; }

        /* STATUS BADGES */
        .status-badge {
            display: inline-flex; align-items: center; gap: var(--space-xs);
            padding: 3px 10px; border-radius: 20px;
            font-size: 0.75rem; font-weight: 600;
            text-transform: capitalize;
        }
        .status-badge.submitted, .status-badge.complete { background: #dafbe1; color: var(--status-complete); }
        .status-badge.draft, .status-badge.info { background: #ddf4ff; color: var(--status-info); }
        .status-badge.pending, .status-badge.warning { background: #fff8c5; color: var(--status-pending); }
        .status-badge.blocked { background: #ffebe9; color: var(--status-blocked); }
        .status-badge.review { background: #e2d9f3; color: #432874; }
        .status-badge.registered { background: #0f5132; color: white; }
        .status-badge.not-started { background: var(--bg-subtle); color: var(--text-secondary); border: 1px dashed var(--border-default); }

        /* ALERT BANNERS */
        .alert-banner { display: flex; align-items: center; gap: var(--space-md); padding: var(--space-md) var(--space-lg); border-radius: var(--radius-md); margin-bottom: var(--space-md); }
        .alert-banner.danger { background: #ffebe9; border: 1px solid #ffc1ba; }
        .alert-banner.warning { background: #fff8c5; border: 1px solid #ffecb5; }
        .alert-banner.success { background: #dafbe1; border: 1px solid #aff5b4; }
        .alert-banner-icon { width: 24px; height: 24px; flex-shrink: 0; }
        .alert-banner-content { flex: 1; }
        .alert-banner-title { font-weight: 600; font-size: 0.9rem; }
        .alert-banner-text { font-size: 0.8rem; color: var(--text-secondary); margin-top: 2px; }
        .btn-danger { background: var(--status-blocked); color: white; border: none; }

        /* PIPELINE VIEW */
        .pipeline-container { background: var(--bg-card); border: 1px solid var(--border-default); border-radius: var(--radius-lg); margin-bottom: var(--space-xl); overflow: hidden; }
        .pipeline-header { display: flex; justify-content: space-between; align-items: center; padding: var(--space-md) var(--space-lg); border-bottom: 1px solid var(--border-default); background: var(--bg-subtle); }
        .pipeline-title { font-weight: 600; font-size: 0.95rem; }
        .pipeline-stages { display: grid; grid-template-columns: repeat(6, 1fr); min-height: 300px; }
        .pipeline-stage { border-right: 1px solid var(--border-default); padding: var(--space-md); background: var(--bg-card); }
        .pipeline-stage:last-child { border-right: none; }
        .pipeline-stage-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md); padding-bottom: var(--space-sm); border-bottom: 2px solid var(--border-default); }
        .pipeline-stage-header.stage-new { border-color: var(--status-info); }
        .pipeline-stage-header.stage-submitted { border-color: var(--rk-accent); }
        .pipeline-stage-header.stage-checks { border-color: var(--status-pending); }
        .pipeline-stage-header.stage-review { border-color: #6f42c1; }
        .pipeline-stage-header.stage-blocked { border-color: var(--status-blocked); }
        .pipeline-stage-header.stage-approved { border-color: var(--status-complete); }
        .pipeline-stage-title { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em; }
        .pipeline-stage-count { font-size: 0.7rem; background: var(--bg-subtle); padding: 2px 8px; border-radius: 20px; font-weight: 600; }
        .pipeline-cards { display: flex; flex-direction: column; gap: var(--space-sm); max-height: 400px; overflow-y: auto; }
        .pipeline-card { background: var(--bg-subtle); border-radius: var(--radius-md); padding: var(--space-sm); cursor: pointer; transition: all 0.15s ease; border: 1px solid transparent; }
        .pipeline-card:hover { border-color: var(--rk-accent); box-shadow: var(--shadow-sm); }
        .pipeline-card-name { font-weight: 600; font-size: 0.85rem; margin-bottom: 2px; }
        .pipeline-card-ref { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: var(--text-secondary); margin-bottom: var(--space-xs); }
        .pipeline-card-progress { height: 4px; background: var(--border-default); border-radius: 20px; overflow: hidden; margin-bottom: var(--space-xs); }
        .pipeline-card-progress-fill { height: 100%; border-radius: 20px; }
        .pipeline-card-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem; }
        .pipeline-card-days { color: var(--text-secondary); }
        .pipeline-card-days.overdue { color: var(--status-blocked); font-weight: 600; }
        .pipeline-card-risk { width: 8px; height: 8px; border-radius: 50%; }
        .pipeline-card-risk.high { background: var(--status-blocked); }
        .pipeline-card-risk.medium { background: var(--status-pending); }
        .pipeline-card-risk.low { background: var(--status-complete); }

        /* DATA TABLE */
        .table-container {
            background: var(--bg-card);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        .table-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-default);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .table-title { font-size: 1.1rem; font-weight: 700; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th {
            text-align: left;
            padding: var(--space-md) var(--space-lg);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: var(--bg-subtle);
            border-bottom: 1px solid var(--border-default);
        }
        .data-table td {
            padding: var(--space-md) var(--space-lg);
            font-size: 0.875rem;
            border-bottom: 1px solid var(--border-subtle);
        }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover td { background: var(--bg-subtle); cursor: pointer; }

        /* SEARCH BAR */
        .search-bar { display: flex; gap: var(--space-sm); margin-bottom: var(--space-lg); }
        .search-input-wrapper { flex: 1; position: relative; }
        .search-input {
            width: 100%;
            padding: var(--space-sm) var(--space-md) var(--space-sm) 40px;
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            font-family: inherit;
        }
        .search-input:focus { outline: none; border-color: var(--rk-primary); box-shadow: var(--shadow-focus); }
        .search-input-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px; height: 18px;
            color: var(--text-secondary);
        }
        .filter-dropdown {
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            background: var(--bg-card);
            font-family: inherit;
        }

        /* DETAIL PANEL */
        .detail-panel-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3);
            z-index: 999;
            opacity: 0; pointer-events: none;
            transition: opacity 0.2s ease;
        }
        .detail-panel-backdrop.open { opacity: 1; pointer-events: auto; }
        .detail-panel {
            position: fixed; top: 0; right: -520px;
            width: 500px; height: 100vh;
            background: var(--bg-card);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .detail-panel.open { right: 0; }
        .detail-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-default);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .detail-header-title { font-size: 1.15rem; font-weight: 700; }
        .detail-header-ref { font-size: 0.8rem; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace; }
        .detail-close {
            width: 32px; height: 32px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-default);
            background: var(--bg-card);
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .detail-close:hover { background: var(--bg-subtle); }
        .detail-body { padding: var(--space-lg); overflow-y: auto; flex: 1; }
        .detail-section { margin-bottom: var(--space-lg); }
        .detail-section-title { font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); margin-bottom: var(--space-md); padding-bottom: var(--space-xs); border-bottom: 1px solid var(--border-subtle); }
        .detail-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-sm); background: var(--bg-subtle); padding: var(--space-md); border-radius: var(--radius-md); }
        .detail-label { font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 2px; }
        .detail-value { font-weight: 500; font-size: 0.875rem; word-break: break-word; }

        /* PROGRESS RING */
        .progress-ring { width: 60px; height: 60px; position: relative; }
        .progress-ring-circle {
            fill: none;
            stroke-width: 6;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: center;
        }
        .progress-ring-bg { stroke: var(--border-default); }
        .progress-ring-value { stroke: var(--status-complete); transition: stroke-dashoffset 0.35s; }
        .progress-ring-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.8rem;
            font-weight: 700;
        }

        /* DETAIL GRID */
        .detail-grid {
             display: grid;
             grid-template-columns: repeat(2, 1fr);
             gap: var(--space-md);
             margin-bottom: var(--space-lg);
        }
        .detail-label { font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px; }
        .detail-value { font-size: 0.9rem; font-weight: 500; }

        /* TABS */
        .tabs { display: flex; gap: 2px; border-bottom: 1px solid var(--border-default); margin-bottom: var(--space-lg); }
        .tab {
            padding: var(--space-sm) var(--space-md);
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
            background: none;
            border: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.15s ease;
        }
        .tab:hover { color: var(--text-primary); }
        .tab.active { color: var(--rk-primary); border-bottom-color: var(--rk-primary); font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* REFERENCE/HOUSEHOLD CARDS */
        .person-card {
            padding: var(--space-md);
            border: 1px solid var(--border-default);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-sm);
            transition: background 0.15s ease;
        }
        .person-card:hover { background: var(--bg-subtle); }
        .person-card-name { font-weight: 600; margin-bottom: var(--space-xs); }
        .person-card-meta { font-size: 0.8rem; color: var(--text-secondary); }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: var(--space-xl) * 2;
            color: var(--text-secondary);
        }
        .empty-state-icon { font-size: 3rem; margin-bottom: var(--space-md); }
        .empty-state-text { font-size: 1rem; }

        /* MESSAGES */
        .messages { margin-bottom: var(--space-lg); }
        .alert { padding: var(--space-md); border-radius: var(--radius-md); margin-bottom: var(--space-sm); font-size: 0.875rem; }
        .alert-success { background: #dafbe1; color: var(--status-complete); border: 1px solid #aff5b4; }
        .alert-error { background: #ffebe9; color: var(--status-blocked); border: 1px solid #ffc1ba; }

        /* RESPONSIVE */
        @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } .pipeline-stages { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 768px) {
            .app-container { grid-template-columns: 1fr; }
            .sidebar { display: none; }
            .stats-grid { grid-template-columns: 1fr; }
            .pipeline-stages { grid-template-columns: 1fr; }
            .detail-panel { width: 100%; right: -100%; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-brand">
                <div class="sidebar-brand-icon">RK</div>
                <div class="sidebar-brand-text">
                    Ready Kids
                    <span>CMA Portal</span>
                </div>
            </div>

            <nav>
                <ul class="sidebar-nav">
                    <li>
                        <a class="sidebar-nav-link active" data-view="dashboard" onclick="switchView('dashboard')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                            Dashboard
                        </a>
                    </li>
                    <li>
                        <a class="sidebar-nav-link" data-view="applications" onclick="switchView('applications')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                            Applications
                            <span class="sidebar-nav-badge info">{{ total_apps }}</span>
                        </a>
                    </li>
                    <li>
                        <a class="sidebar-nav-link">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            Connected Persons
                            <span class="sidebar-nav-badge warning">{{ total_connected_persons }}</span>
                        </a>
                    </li>
                    <li>
                        <a class="sidebar-nav-link">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                            Ofsted Checks
                        </a>
                    </li>
                </ul>

                <div class="sidebar-section-title">External Checks</div>
                <ul class="sidebar-nav">
                    <li>
                        <a class="sidebar-nav-link">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                            DBS Status
                        </a>
                    </li>
                    <li>
                        <a class="sidebar-nav-link">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                            LA Checks
                            <span class="sidebar-nav-badge">3</span>
                        </a>
                    </li>
                    <li>
                        <a class="sidebar-nav-link">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                            GP Health
                        </a>
                    </li>
                    <li>
                        <a class="sidebar-nav-link">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                            References
                        </a>
                    </li>
                </ul>

                <div class="sidebar-section-title">System</div>
                <ul class="sidebar-nav">
                    <li>
                        <a class="sidebar-nav-link">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                            Settings
                        </a>
                    </li>
                </ul>
            </nav>

            <div class="sidebar-stats">
                <div class="sidebar-stat">
                    <span>Avg. Processing</span>
                    <span class="sidebar-stat-value">18.5d</span>
                </div>
                <div class="sidebar-stat">
                    <span>This Month</span>
                    <span class="sidebar-stat-value">+{{ total_apps }}</span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            {% if messages %}
            <div class="messages">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Dashboard View -->
            <div id="dashboardView" class="view-container" style="display:block;">
                <div class="main-header">
                    <div>
                        <h1 class="main-title">Application Management</h1>
                        <p class="main-subtitle">Monitor and manage childminder registrations</p>
                    </div>
                    <div class="header-actions">
                        <button class="btn btn-secondary">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            Export
                        </button>
                        <a href="/register/" class="btn btn-primary">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            New Application
                        </a>
                    </div>
                </div>

                <!-- Alert Banner -->
                {% if submitted_apps > 0 %}
                <div class="alert-banner danger">
                    <svg class="alert-banner-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    <div class="alert-banner-content">
                        <div class="alert-banner-title">{{ submitted_apps }} Application{{ submitted_apps|pluralize }} Require{{ submitted_apps|pluralize:",s" }} Review</div>
                        <div class="alert-banner-text">New submissions pending compliance checks</div>
                    </div>
                    <button class="btn btn-sm btn-danger">View All</button>
                </div>
                {% endif %}

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card urgent">
                        <span class="stat-card-trend down">↓ 1</span>
                        <div class="stat-card-value">{{ require_action_apps }}</div>
                        <div class="stat-card-label">Require Action</div>
                    </div>
                    <div class="stat-card warning">
                        <span class="stat-card-trend up">↑ {{ in_progress_apps }}</span>
                        <div class="stat-card-value">{{ in_progress_apps }}</div>
                        <div class="stat-card-label">In Progress</div>
                    </div>
                    <div class="stat-card success">
                        <span class="stat-card-trend up">↑ {{ completed_apps }}</span>
                        <div class="stat-card-value">{{ completed_apps }}</div>
                        <div class="stat-card-label">Completed (YTD)</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-card-value">{{ registered_apps }}</div>
                        <div class="stat-card-label">Registered</div>
                    </div>
                </div>

                <!-- Application Pipeline -->
                <div class="pipeline-container">
                    <div class="pipeline-header">
                        <div class="pipeline-title">Application Pipeline</div>
                        <div style="display: flex; gap: var(--space-sm);">
                            <button class="btn btn-sm btn-outline">List View</button>
                            <button class="btn btn-sm btn-secondary">Pipeline View</button>
                        </div>
                    </div>
                    <div class="pipeline-stages" id="pipelineStages"></div>
                </div>

                <!-- Compliance Overview Table -->
                <div class="pipeline-container">
                    <div class="pipeline-header">
                        <div class="pipeline-title">Compliance Check Status</div>
                        <button class="btn btn-sm btn-outline">Export Matrix</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Applicant</th>
                                <th>DBS</th>
                                <th>LA Check</th>
                                <th>Ofsted</th>
                                <th>GP Health</th>
                                <th>References</th>
                                <th>Training</th>
                                <th>Stage</th>
                            </tr>
                        </thead>
                        <tbody id="complianceTableBody"></tbody>
                    </table>
                </div>


            </div>

            <!-- Applications View (Full list with search) -->
            <div id="applicationsView" class="view-container" style="display:none;">
                <div class="main-header">
                    <div>
                        <h1 class="main-title">All Applications</h1>
                        <p class="main-subtitle">Complete list of childminder registrations</p>
                    </div>
                </div>

                <div class="search-bar">
                    <div class="search-input-wrapper">
                        <svg class="search-input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                        <input type="text" class="search-input" placeholder="Search applications..." id="appSearchInput" oninput="filterApplications()">
                    </div>
                    <select class="filter-dropdown" id="statusFilter" onchange="filterApplications()">
                        <option value="">All Stages</option>
                        <option value="new">New</option>
                        <option value="form_review">Form Review</option>
                        <option value="dbs_checks">DBS Checks</option>
                        <option value="compliance">Compliance</option>
                        <option value="final_review">Final Review</option>
                        <option value="registered">Registered</option>
                    </select>
                </div>

                <div class="table-container">
                    <table class="data-table" id="applicationsTable">
                        <thead>
                            <tr>
                                <th>Reference</th>
                                <th>Applicant</th>
                                <th>Local Authority</th>
                                <th>Registers</th>
                                <th>Progress</th>
                                <th>Stage</th>
                                <th>Days</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="applicationsTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Detail Panel Backdrop -->
    <div class="detail-panel-backdrop" id="detailBackdrop" onclick="closeDetailPanel()"></div>

    <!-- Detail Panel -->
    <div class="detail-panel" id="detailPanel">
        <div class="detail-header">
            <div>
                <div class="detail-header-title" id="detailName"></div>
                <div class="detail-header-ref" id="detailRef"></div>
            </div>
            <button class="detail-close" onclick="closeDetailPanel()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <div class="detail-body" id="detailBody"></div>
    </div>

    <script>
        // ==========================================
        // APPLICATION DATA (from Django)
        // ==========================================
        const applicationsData = JSON.parse('{{ apps_json|escapejs }}');

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================
        function getProgressColor(progress) {
            if (progress >= 80) return 'var(--status-complete)';
            if (progress >= 50) return 'var(--status-pending)';
            return 'var(--status-info)';
        }

        function getStageLabel(stage) {
            const labels = {
                'new': 'New', 
                'form_review': 'Form Review', 
                'dbs_checks': 'DBS Checks',
                'compliance': 'Compliance', 
                'final_review': 'Final Review', 
                'registered': 'Registered',
                'SUBMITTED': 'Form Review', // Map Django status
                'DRAFT': 'New'            // Map Django status
            };
            return labels[stage] || stage;
        }

        function getStageClass(stage) {
            const classes = {
                'new': 'info', 
                'form_review': 'info', 
                'SUBMITTED': 'info',
                'dbs_checks': 'pending',
                'compliance': 'review', 
                'final_review': 'complete', 
                'registered': 'registered',
                'DRAFT': 'draft'
            };
            return classes[stage] || 'draft';
        }

        function getCheckIcon(status) {
            const icons = { 'complete': '✓', 'pending': '◔', 'blocked': '!', 'not-started': '○', 'expired': '⚠' };
            return icons[status] || '○';
        }

        function calculateDays(dateStr) {
            if (!dateStr) return 0;
            return Math.floor((Date.now() - new Date(dateStr)) / 86400000);
        }

        function renderComplianceTable() {
            const tbody = document.getElementById('complianceTableBody');
            if(!tbody) return;

            tbody.innerHTML = applicationsData.filter(a => a.status !== 'DRAFT').map(app => `
                <tr onclick="openDetailPanel('${app.id}')">
                    <td>
                        <div style="font-weight: 600;">${app.personal ? app.personal.first_name + ' ' + app.personal.last_name : 'Unknown'}</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">${app.id}</div>
                    </td>
                    <td><span class="status-badge ${app.checks.dbs.status}">${getCheckIcon(app.checks.dbs.status)}</span></td>
                    <td><span class="status-badge ${app.checks.la_check.status}">${getCheckIcon(app.checks.la_check.status)}</span></td>
                    <td><span class="status-badge ${app.checks.ofsted.status}">${getCheckIcon(app.checks.ofsted.status)}</span></td>
                    <td><span class="status-badge ${app.checks.gp_health.status}">${getCheckIcon(app.checks.gp_health.status)}</span></td>
                    <td><span class="status-badge ${app.checks.ref_1.status === 'complete' && app.checks.ref_2.status === 'complete' ? 'complete' : app.checks.ref_1.status === 'pending' || app.checks.ref_2.status === 'pending' ? 'pending' : 'not-started'}">${getCheckIcon(app.checks.ref_1.status === 'complete' && app.checks.ref_2.status === 'complete' ? 'complete' : 'pending')}</span></td>
                    <td><span class="status-badge ${app.checks.first_aid.status === 'complete' && app.checks.safeguarding.status === 'complete' ? 'complete' : 'pending'}">${getCheckIcon(app.checks.first_aid.status === 'complete' ? 'complete' : 'pending')}</span></td>
                    <td><span class="status-badge ${getStageClass(getAppStage(app))}">${getStageLabel(getAppStage(app))}</span></td>
                </tr>
            `).join('');
        }

        // ==========================================
        // VIEW SWITCHING
        // ==========================================
        function switchView(viewName) {
            document.querySelectorAll('.view-container').forEach(v => v.style.display = 'none');
            document.querySelectorAll('.sidebar-nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(viewName + 'View').style.display = 'block';
            const navLink = document.querySelector(`[data-view="${viewName}"]`);
            if (navLink) navLink.classList.add('active');

            if (viewName === 'applications') renderApplicationsTable();
        }

        // ==========================================
        // PIPELINE RENDERING (Updated to use helpers)
        // ==========================================
        const pipelineStages = [
            { id: 'new', label: 'New', headerClass: 'stage-new' },
            { id: 'form submitted', label: 'Form Submitted', headerClass: 'stage-submitted' },
            { id: 'in progress', label: 'Checks In Progress', headerClass: 'stage-checks' },
            { id: 'under review', label: 'Under Review', headerClass: 'stage-review' },
            { id: 'blocked', label: 'Blocked', headerClass: 'stage-blocked' },
            { id: 'approved', label: 'Approved / Registered', headerClass: 'stage-approved' }
        ];

        function getAppStage(app) {
            if (app.status === 'SUBMITTED') return 'form submitted';
            if (app.status === 'BLOCKED') return 'blocked'; 
            if (app.status === 'REGISTERED') return 'approved';
            if (app.status === 'CHECKS_IN_PROGRESS') return 'in progress';
            if (app.status === 'UNDER_REVIEW') return 'under review';
            return 'new';
        }

        function renderPipeline() {
            const container = document.getElementById('pipelineStages');
            if (!container) return;

            // Group applications by stage
            const grouped = {};
            pipelineStages.forEach(stage => grouped[stage.id] = []);

            applicationsData.forEach(app => {
                const stage = getAppStage(app);
                if (grouped[stage]) grouped[stage].push(app);
            });

            container.innerHTML = pipelineStages.map(stage => {
                const apps = grouped[stage.id] || [];
                return `
                    <div class="pipeline-stage" data-stage="${stage.id}">
                        <div class="pipeline-stage-header ${stage.headerClass}">
                            <span class="pipeline-stage-title">${stage.label}</span>
                            <span class="pipeline-stage-count">${apps.length}</span>
                        </div>
                        <div class="pipeline-cards">
                            ${apps.map(app => {
                                const days = calculateDays(app.created_at);
                                const name = app.personal ? `${app.personal.first_name} ${app.personal.last_name}` : 'Unknown';
                                const ref = `APP-${app.id}`;
                                const progress = app.status === 'SUBMITTED' ? 60 : 10; 
                                
                                return `
                                <div class="pipeline-card" onclick="openDetailPanel('${app.id}')">
                                    <div class="pipeline-card-name">${name}</div>
                                    <div class="pipeline-card-ref">${ref}</div>
                                    <div class="pipeline-card-progress">
                                        <div class="pipeline-card-progress-fill" style="width: ${progress}%; background: ${getProgressColor(progress)}"></div>
                                    </div>
                                    <div class="pipeline-card-meta">
                                        <span class="pipeline-card-days ${days > 14 ? 'overdue' : ''}">${days} days</span>
                                        ${days > 14 ? '<span class="pipeline-card-risk high"></span>' : ''}
                                    </div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==========================================
        // RENDER TABLE
        // ==========================================
        function renderApplicationsTable() {
            const tbody = document.getElementById('applicationsTableBody');
            if(!tbody) return;

            tbody.innerHTML = applicationsData.map(app => {
                const stage = getAppStage(app);
                const stageLabel = getStageLabel(stage);
                const stageClass = getStageClass(stage);
                const name = app.personal ? `${app.personal.first_name} ${app.personal.last_name}` : 'Incomplete';
                const email = app.personal ? app.personal.email : 'No email';
                const progress = app.status === 'SUBMITTED' ? 60 : 20; // Mock progress based on status
                const days = calculateDays(app.created_at);
                const registers = app.registers || ['0-5']; // Mock registers if missing

                return `
                <tr class="app-row" data-status="${app.status}" data-name="${name}" onclick="openDetailPanel('${app.id}')">
                    <td><span style="font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;">APP-${app.id}</span></td>
                    <td>
                        <div style="font-weight: 600;">${name}</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">${email}</div>
                    </td>
                    <td>${app.local_authority || 'Leeds'}</td> 
                    <td>${registers.join(', ')}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 60px; height: 6px; background: var(--border-default); border-radius: 3px; overflow: hidden;">
                                <div style="width: ${progress}%; height: 100%; background: ${getProgressColor(progress)};"></div>
                            </div>
                            <span style="font-size: 0.75rem;">${progress}%</span>
                        </div>
                    </td>
                    <td><span class="status-badge ${stageClass}">${stageLabel}</span></td>
                    <td>${stage === 'registered' ? '-' : days + 'd'}</td>
                    <td><button class="btn btn-sm btn-outline" onclick="event.stopPropagation(); openDetailPanel('${app.id}')">View</button></td>
                </tr>
                `;
            }).join('');
            
            if (applicationsData.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 3rem; color: var(--text-secondary);">No applications found.</td></tr>`;
            }
        }


        // ==========================================
        // SEARCH & FILTER
        // ==========================================
        function filterApplications() {
            const searchTerm = document.getElementById('appSearchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const rows = document.querySelectorAll('.app-row');

            rows.forEach(row => {
                const name = (row.dataset.name || '').toLowerCase();
                // We need to match stage logic, but for now simple status match
                // Ideally filter by stage derived status
                row.style.display = name.includes(searchTerm) ? '' : 'none';
            });
        }

        // ==========================================
        // DETAIL PANEL
        // ==========================================
        function openDetailPanel(appId) {
            const app = applicationsData.find(a => a.id === appId);
            if (!app) return;

            const name = app.personal ? `${app.personal.first_name} ${app.personal.last_name}` : 'Incomplete Application';
            document.getElementById('detailName').textContent = name;
            document.getElementById('detailRef').textContent = `APP-${app.id} · ${app.status_display}`;
            document.getElementById('detailBody').innerHTML = renderDetailContent(app);
            
            // Animate progress ring
            setTimeout(() => {
                const ring = document.querySelector('.progress-ring-value');
                if (ring) {
                    const radius = ring.r.baseVal.value;
                    const circumference = radius * 2 * Math.PI;
                    const progress = app.status === 'SUBMITTED' ? 60 : 20;
                    const offset = circumference - (progress / 100) * circumference;
                    ring.style.strokeDashoffset = offset;
                }
            }, 100);

            document.getElementById('detailPanel').classList.add('open');
            document.getElementById('detailBackdrop').classList.add('open');

            // Initialize tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const tabId = e.target.dataset.tab;
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    e.target.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }

        function closeDetailPanel() {
            document.getElementById('detailPanel').classList.remove('open');
            document.getElementById('detailBackdrop').classList.remove('open');
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            } catch (e) {
                return dateStr;
            }
        }

        function renderDetailContent(app) {
            return `
                ${renderDetailHeader(app)}
                <div class="tabs">
                    <button class="tab active" data-tab="overviewTab">Overview</button>
                    <button class="tab" data-tab="complianceTab">Compliance</button>
                    <button class="tab" data-tab="personsTab">People</button>
                    <button class="tab" data-tab="timelineTab">Timeline</button>
                </div>
                <div id="overviewTab" class="tab-content active">${renderOverviewTab(app)}</div>
                <div id="complianceTab" class="tab-content">${renderComplianceTab(app)}</div>
                <div id="personsTab" class="tab-content">${renderPersonsTab(app)}</div>
                <div id="timelineTab" class="tab-content">${renderTimelineTab(app)}</div>
            `;
        }

        function renderDetailHeader(app) {
            const progress = app.status === 'SUBMITTED' ? 60 : 20;
            const radius = 26;
            const circumference = radius * 2 * Math.PI;
            
            return `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg); background: var(--bg-subtle); padding: var(--space-md); border-radius: var(--radius-md);">
                    <div style="display: flex; align-items: center; gap: var(--space-md);">
                        <div class="progress-ring">
                            <svg width="60" height="60">
                                <circle class="progress-ring-bg" stroke="var(--border-default)" stroke-width="4" fill="transparent" r="${radius}" cx="30" cy="30"/>
                                <circle class="progress-ring-value" stroke="${getProgressColor(progress)}" stroke-width="4" fill="transparent" r="${radius}" cx="30" cy="30" style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${circumference};"/>
                            </svg>
                            <div class="progress-ring-text">${progress}%</div>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary); font-size: 1.1rem;">${getStageLabel(getAppStage(app))}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Current Stage</div>
                        </div>
                    </div>
                     <span class="status-badge ${getStageClass(getAppStage(app))}" style="font-size: 0.9rem; padding: 4px 12px;">${app.status_display}</span>
                </div>
            `;
        }

        function renderOverviewTab(app) {
            const p = app.personal;
            if (!p) return '<div class="alert alert-warning">Personal details incomplete</div>';
            
            const pr = app.premises || {};
            
            return `
                <div class="detail-section">
                    <div class="detail-section-title">Personal Details</div>
                    <div class="detail-grid">
                        <div><div class="detail-label">Full Name</div><div class="detail-value">${p.first_name} ${p.middle_names} ${p.last_name}</div></div>
                        <div><div class="detail-label">Date of Birth</div><div class="detail-value">${formatDate(p.dob)}</div></div>
                        <div><div class="detail-label">Email</div><div class="detail-value">${p.email}</div></div>
                        <div><div class="detail-label">Phone</div><div class="detail-value">${p.phone}</div></div>
                        <div><div class="detail-label">NI Number</div><div class="detail-value">${p.ni_number || '-'}</div></div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-section-title">Premises & Service</div>
                     <div class="detail-grid">
                        <div><div class="detail-label">Local Authority</div><div class="detail-value">${pr.local_authority || 'Leeds'}</div></div>
                        <div><div class="detail-label">Premises Type</div><div class="detail-value">${pr.premises_type || 'Domestic'}</div></div>
                        <div><div class="detail-label">Address</div><div class="detail-value">${pr.is_own_home ? 'Own Home' : 'Rented'}</div></div>
                        <div><div class="detail-label">Registers</div><div class="detail-value">${(app.registers || ['0-5']).join(', ')}</div></div>
                    </div>
                </div>
            `;
        }

        function renderComplianceTab(app) {
             const getIcon = (status) => {
                if (status === true || status === 'True') return '✓';
                if (status === false || status === 'False') return '○';
                return '○';
            };
            const getClass = (status) => {
                 if (status === true || status === 'True') return 'complete';
                 return 'not-started';
            };

            const t = app.training || {};
            const s = app.suitability || {};

            return `
                <div class="detail-section">
                    <div class="detail-section-title">Checks & Suitability</div>
                     <table class="data-table" style="margin-top: var(--space-sm);">
                        <thead>
                            <tr>
                                <th>Check Type</th>
                                <th>Status</th>
                                <th>Date/Ref</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>DBS Check</td>
                                <td><span class="status-badge ${getClass(s.has_dbs)}">${s.has_dbs ? 'Clear' : 'Pending'}</span></td>
                                <td style="font-family: monospace;">${s.dbs_number || '-'}</td>
                            </tr>
                            <tr>
                                <td>Social Services</td>
                                <td><span class="status-badge ${getClass(!s.social_services_involved)}">${!s.social_services_involved ? 'Clear' : 'Review'}</span></td>
                                <td>-</td>
                            </tr>
                            <tr>
                                <td>Health Check</td>
                                <td><span class="status-badge ${getClass(!s.has_medical_condition)}">${!s.has_medical_condition ? 'Clear' : 'Review'}</span></td>
                                <td>-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="detail-section">
                    <div class="detail-section-title">Training</div>
                    <table class="data-table" style="margin-top: var(--space-sm);">
                        <thead>
                            <tr>
                                <th>Training Module</th>
                                <th>Status</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                             <tr>
                                <td>Paediatric First Aid</td>
                                <td><span class="status-badge ${getClass(t.first_aid_completed)}">${t.first_aid_completed ? 'Complete' : 'Pending'}</span></td>
                                <td>${formatDate(t.first_aid_date)}</td>
                            </tr>
                            <tr>
                                <td>Safeguarding</td>
                                <td><span class="status-badge ${getClass(t.safeguarding_completed)}">${t.safeguarding_completed ? 'Complete' : 'Pending'}</span></td>
                                <td>${formatDate(t.safeguarding_date)}</td>
                            </tr>
                            <tr>
                                <td>Food Hygiene</td>
                                <td><span class="status-badge ${getClass(t.food_hygiene_completed)}">${t.food_hygiene_completed ? 'Complete' : 'Pending'}</span></td>
                                <td>-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderPersonsTab(app) {
             const members = app.household_members || [];
             if (members.length === 0) return '<div style="color: var(--text-secondary); padding: var(--space-md);">No connected persons listed.</div>';

             return `
                <div class="detail-section">
                    <div class="detail-section-title">Household Members</div>
                    <div class="pipeline-cards">
                        ${members.map(m => `
                             <div class="pipeline-card" style="cursor: default;">
                                <div class="pipeline-card-name">${m.first_name} ${m.last_name}</div>
                                <div class="pipeline-card-ref">Household Member</div>
                                <div class="pipeline-card-meta">
                                    <span class="pipeline-card-risk low">Clear</span>
                                    <span style="font-size: 0.75rem; color: var(--text-secondary); margin-left: auto;">DOB: ${formatDate(m.dob)}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
             `;
        }

        function renderTimelineTab(app) {
             // Mock timeline
             const events = [
                 { date: app.created_at, title: 'Application Started', type: 'info' },
             ];
             if (app.status === 'SUBMITTED') {
                 events.unshift({ date: new Date().toISOString(), title: 'Application Submitted', type: 'success' });
             }

             return `
                 <div class="detail-section">
                    <div class="detail-section-title">Activity History</div>
                    <div style="margin-top: var(--space-sm);">
                        ${events.map(e => `
                            <div style="display: flex; gap: var(--space-md); padding-bottom: var(--space-md); border-left: 2px solid var(--border-default); padding-left: var(--space-md); margin-left: 8px;">
                                <div style="font-size: 0.8rem; color: var(--text-secondary); width: 100px;">${formatDate(e.date)}</div>
                                <div>
                                    <div style="font-weight: 500;">${e.title}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                 </div>
             `;
        }
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeDetailPanel();
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            renderPipeline();
            renderApplicationsTable();
            renderComplianceTable();
        });
        if (document.readyState !== 'loading') renderPipeline();
    </script>
</body>
</html>

