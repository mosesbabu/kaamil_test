{% extends 'base.html' %}

{% block title %}Apply to register as a childminder - ReadyKids{% endblock %}

{% block extra_css %}
<style>
    :root {
        --rk-primary: #0C7C59;
        --rk-primary-dark: #095C43;
        --rk-primary-light: #E8F5F0;
        --rk-primary-glow: rgba(12, 124, 89, 0.12);
        --rk-accent: #1B9AAA;
        --rk-accent-light: #E6F5F7;
        --rk-success: #059669;
        --rk-success-bg: #D1FAE5;
        --rk-warning: #D97706;
        --rk-warning-bg: #FEF3C7;
        --rk-error: #DC2626;
        --rk-error-bg: #FEE2E2;
        --rk-info: #2563EB;
        --rk-info-bg: #DBEAFE;
        --rk-black: #0F172A;
        --rk-gray-900: #1E293B;
        --rk-gray-800: #334155;
        --rk-gray-700: #475569;
        --rk-gray-600: #64748B;
        --rk-gray-500: #94A3B8;
        --rk-gray-400: #CBD5E1;
        --rk-gray-300: #E2E8F0;
        --rk-gray-200: #F1F5F9;
        --rk-gray-100: #F8FAFC;
        --rk-white: #FFFFFF;
        --rk-focus: #FACC15;
        --font-display: 'Fraunces', Georgia, serif;
        --font-body: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
        --space-1: 0.25rem; --space-2: 0.5rem; --space-3: 0.75rem; --space-4: 1rem;
        --space-5: 1.25rem; --space-6: 1.5rem; --space-8: 2rem; --space-10: 2.5rem;
        --radius-sm: 6px; --radius-md: 10px; --radius-lg: 16px;
        --shadow-sm: 0 1px 2px rgba(15, 23, 42, 0.04);
        --shadow-md: 0 4px 12px rgba(15, 23, 42, 0.08);
        --shadow-lg: 0 12px 40px rgba(15, 23, 42, 0.12);
        --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-normal: 250ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Override base styles for this specific page if needed */
    .form-grid {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: var(--space-8);
        padding: var(--space-4) 0;
    }
    @media (max-width: 1024px) {
        .form-grid { grid-template-columns: 1fr; padding: var(--space-4); }
    }

    .sidebar { position: sticky; top: 100px; height: fit-content; }
    @media (max-width: 1024px) { .sidebar { position: relative; top: 0; } }
    .progress-card { background: var(--rk-white); border-radius: var(--radius-lg); padding: var(--space-6); box-shadow: var(--shadow-md); margin-bottom: var(--space-6); }
    .progress-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: var(--space-4); }
    .progress-title { font-weight: 600; color: var(--rk-gray-800); font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; }
    .progress-percent { font-family: var(--font-display); font-size: 1.5rem; font-weight: 700; color: var(--rk-primary); }
    .progress-bar-container { height: 8px; background: var(--rk-gray-200); border-radius: 4px; overflow: hidden; margin-bottom: var(--space-4); }
    .progress-bar { height: 100%; background: linear-gradient(90deg, var(--rk-primary) 0%, var(--rk-accent) 100%); border-radius: 4px; width: 0%; transition: width 0.4s ease-out; }
    .progress-steps { font-size: 0.875rem; color: var(--rk-gray-600); }

    .section-nav { background: var(--rk-white); border-radius: var(--radius-lg); padding: var(--space-4); box-shadow: var(--shadow-md); }
    .nav-item {
        display: flex; align-items: center; gap: var(--space-3);
        padding: var(--space-3) var(--space-4);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all var(--transition-fast);
        margin-bottom: var(--space-1);
        border: 2px solid transparent;
    }
    .nav-item:hover { background: var(--rk-gray-100); }
    .nav-item.active { background: var(--rk-primary-light); border-color: var(--rk-primary); }
    .nav-number {
        width: 28px; height: 28px; border-radius: 50%;
        background: var(--rk-gray-300); color: var(--rk-white);
        display: flex; align-items: center; justify-content: center;
        font-size: 0.75rem; font-weight: 600; flex-shrink: 0;
    }
    .nav-item.active .nav-number { background: var(--rk-primary); box-shadow: 0 2px 8px rgba(12, 124, 89, 0.3); }
    .nav-text { font-size: 0.875rem; font-weight: 500; color: var(--rk-gray-700); }
    .nav-item.active .nav-text { color: var(--rk-primary-dark); font-weight: 600; }

    .form-container { background: var(--rk-white); border-radius: 20px; box-shadow: var(--shadow-lg); overflow: hidden; }
    .form-header {
        background: linear-gradient(135deg, var(--rk-primary) 0%, var(--rk-primary-dark) 100%);
        color: var(--rk-white);
        padding: var(--space-8) var(--space-10);
    }
    .form-header h1 { font-family: var(--font-display); font-size: 2rem; font-weight: 700; margin-bottom: var(--space-2); }
    .form-header p { opacity: 0.9; font-size: 1rem; }
    .form-body { padding: var(--space-10); }

    .form-section { display: none; animation: fadeIn 0.25s ease-out; }
    .form-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    
    .section-title { font-family: var(--font-display); font-size: 1.75rem; font-weight: 700; color: var(--rk-gray-900); margin-bottom: var(--space-2); }
    .section-description { color: var(--rk-gray-600); font-size: 1rem; margin-bottom: var(--space-8); max-width: 600px; line-height: 1.7; }
    .subsection { margin-bottom: var(--space-10); padding-bottom: var(--space-8); border-bottom: 1px solid var(--rk-gray-200); }
    .subsection:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .subsection-title { font-size: 1.125rem; font-weight: 600; color: var(--rk-gray-800); margin-bottom: var(--space-5); display: flex; align-items: center; gap: var(--space-3); }

    .error-summary { background: var(--rk-error-bg); border: 2px solid var(--rk-error); border-radius: var(--radius-lg); padding: var(--space-6); margin-bottom: var(--space-8); display: none; }
    .error-summary.active { display: block; animation: shake 0.4s ease-out; }
    @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); } 20%, 40%, 60%, 80% { transform: translateX(4px); } }
    .error-summary-header { display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-3); }
    .error-summary-header svg { width: 24px; height: 24px; color: var(--rk-error); }
    .error-summary h3 { font-size: 1.125rem; font-weight: 600; color: var(--rk-error); }
    .error-summary p { color: var(--rk-gray-700); }

    .info-box { padding: var(--space-5); border-radius: var(--radius-md); margin-bottom: var(--space-6); display: flex; gap: var(--space-4); }
    .info-box.info { background: var(--rk-info-bg); border-left: 4px solid var(--rk-info); }
    .info-box .icon { flex-shrink: 0; width: 24px; height: 24px; }
    .info-box.info .icon { color: var(--rk-info); }
    .info-box-content h4 { font-size: 0.9375rem; font-weight: 600; color: var(--rk-gray-800); margin-bottom: var(--space-1); }
    .info-box-content p { font-size: 0.9375rem; color: var(--rk-gray-700); line-height: 1.6; }

    .field-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-5); }
    .field-grid-2 { grid-template-columns: repeat(2, 1fr); }
    @media (max-width: 768px) { .field-grid, .field-grid-2 { grid-template-columns: 1fr; } }
    .field { margin-bottom: var(--space-5); }
    .field-grid > .field { margin-bottom: 0; }
    .field.full-width { grid-column: 1 / -1; }
    .field-label { display: block; font-size: 0.9375rem; font-weight: 600; color: var(--rk-gray-800); margin-bottom: var(--space-2); }
    .required { color: var(--rk-error); margin-left: 2px; }
    .field-hint { display: block; font-size: 0.875rem; color: var(--rk-gray-600); margin-bottom: var(--space-3); line-height: 1.5; }
    
    .input, .select, select, .textarea { width: 100%; padding: var(--space-3) var(--space-4); border: 2px solid var(--rk-gray-300); border-radius: var(--radius-md); font-family: inherit; font-size: 1rem; transition: all var(--transition-fast); background-color: var(--rk-white); }
    .input:focus, .select:focus, select:focus, .textarea:focus { outline: none; border-color: var(--rk-primary); box-shadow: 0 0 0 4px var(--rk-primary-glow); }
    
    .select, select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23475569' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right var(--space-4) center;
        background-size: 18px;
        padding-right: var(--space-10);
    }
    .input-md { max-width: 250px; }
    .input-sm { max-width: 150px; }
    .input.error, .select.error, .textarea.error, select.error, .has-error .input, .has-error .select, .has-error select { border-color: var(--rk-error); background: var(--rk-error-bg); }
    .field-error { color: var(--rk-error); font-size: 0.8125rem; margin-top: var(--space-1); font-weight: 500; display: block; animation: fadeInError 0.2s ease-out; }
    @keyframes fadeInError { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }

    .btn { display: inline-flex; align-items: center; justify-content: center; gap: var(--space-2); padding: var(--space-4) var(--space-6); font-weight: 600; border-radius: var(--radius-md); cursor: pointer; border: none; transition: all var(--transition-fast); font-size: 1rem; }
    .btn-primary { background: linear-gradient(135deg, var(--rk-primary) 0%, var(--rk-primary-dark) 100%); color: white; box-shadow: 0 4px 12px rgba(12, 124, 89, 0.25); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(12, 124, 89, 0.35); }
    .btn-secondary { background: var(--rk-white); color: var(--rk-gray-700); border: 2px solid var(--rk-gray-300); }
    .btn-lg { padding: 1rem 2rem; font-size: 1.125rem; }

    .repeating-block { background: var(--rk-gray-100); padding: var(--space-6); border-radius: var(--radius-lg); margin-bottom: var(--space-8); border: 1px solid var(--rk-gray-200); position: relative; }
    .repeating-block-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-5); padding-bottom: var(--space-4); border-bottom: 1px solid var(--rk-gray-300); }
    .repeating-block-title { font-weight: 600; color: var(--rk-gray-800); }
    
    .add-btn { display: inline-flex; align-items: center; gap: var(--space-2); padding: var(--space-3) var(--space-5); font-weight: 500; color: var(--rk-primary); background: var(--rk-white); border: 2px dashed var(--rk-primary); border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-fast); margin-top: var(--space-2); margin-bottom: var(--space-6); }
    .add-btn:hover { background: var(--rk-primary-light); border-style: solid; }
    .remove-btn { color: var(--rk-error); font-weight: 500; font-size: 0.875rem; background: none; border: none; cursor: pointer; }

    .form-navigation { display: flex; justify-content: space-between; align-items: center; margin-top: var(--space-10); padding-top: var(--space-8); border-top: 1px solid var(--rk-gray-200); }
    .hidden { display: none !important; }

    /* Radio & Checkbox */
    .radio-group, .checkbox-group { display: flex; flex-direction: column; gap: var(--space-3); }
    .radio-group.horizontal, .checkbox-group.horizontal { flex-direction: row; flex-wrap: wrap; gap: var(--space-4); }
    .radio-item, .checkbox-item {
        display: flex; align-items: flex-start; gap: var(--space-3);
        padding: var(--space-4);
        background: var(--rk-gray-100);
        border: 2px solid transparent;
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all var(--transition-fast);
        position: relative;
    }
    .radio-item:hover, .checkbox-item:hover { background: var(--rk-gray-200); }
    .radio-item.selected, .checkbox-item.selected { background: var(--rk-primary-light); border-color: var(--rk-primary); }
    .radio-item.error, .checkbox-item.error { border-color: var(--rk-error); background: var(--rk-error-bg); }
    .consent-item.error { border-color: var(--rk-error); background: var(--rk-error-bg); }
    .radio-item input, .checkbox-item input, .consent-item input { position: absolute; opacity: 0; cursor: pointer; }
    .radio-indicator, .checkbox-indicator {
        width: 22px; height: 22px; min-width: 22px;
        border: 2px solid var(--rk-gray-400);
        display: flex; align-items: center; justify-content: center;
        transition: all var(--transition-fast);
        flex-shrink: 0;
    }
    .radio-indicator { border-radius: 50%; }
    .checkbox-indicator { border-radius: var(--radius-sm); }
    .radio-item.selected .radio-indicator, .checkbox-item.selected .checkbox-indicator { border-color: var(--rk-primary); background: var(--rk-primary); }
    .radio-indicator::after { content: ''; width: 8px; height: 8px; border-radius: 50%; background: var(--rk-white); opacity: 0; transform: scale(0); transition: all var(--transition-fast); }
    .radio-item.selected .radio-indicator::after { opacity: 1; transform: scale(1); }
    .checkbox-indicator svg { width: 14px; height: 14px; color: var(--rk-white); opacity: 0; transform: scale(0); transition: all var(--transition-fast); }
    .checkbox-item.selected .checkbox-indicator svg { opacity: 1; transform: scale(1); }
    .option-content { flex: 1; }
    .option-label { font-weight: 500; color: var(--rk-gray-800); }
    .option-description { font-size: 0.875rem; color: var(--rk-gray-600); margin-top: var(--space-1); }

    /* Info Box Variants */
    .info-box.warning { background: var(--rk-warning-bg); border-left: 4px solid var(--rk-warning); }
    .info-box.success { background: var(--rk-success-bg); border-left: 4px solid var(--rk-success); }
    .info-box.error { background: var(--rk-error-bg); border-left: 4px solid var(--rk-error); }
    .info-box.warning .icon { color: var(--rk-warning); }
    .info-box.success .icon { color: var(--rk-success); }
    .info-box.error .icon { color: var(--rk-error); }

    /* Capacity Calculator */
    .capacity-calculator {
        background: linear-gradient(135deg, var(--rk-primary-light) 0%, var(--rk-accent-light) 100%);
        border: 2px solid var(--rk-primary);
        border-radius: var(--radius-lg);
        padding: var(--space-6);
        margin-top: var(--space-6);
    }
    .capacity-header { display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-5); }
    .capacity-icon { width: 40px; height: 40px; background: var(--rk-primary); color: var(--rk-white); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; }
    .capacity-title { font-size: 1.125rem; font-weight: 600; color: var(--rk-gray-800); }
    .capacity-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: var(--space-4); }
    .capacity-card { background: var(--rk-white); border-radius: var(--radius-md); padding: var(--space-4); text-align: center; box-shadow: var(--shadow-sm); }
    .capacity-number { font-family: var(--font-display); font-size: 2rem; font-weight: 700; color: var(--rk-primary); line-height: 1; margin-bottom: var(--space-1); }
    .capacity-label { font-size: 0.8125rem; color: var(--rk-gray-600); line-height: 1.3; }

    /* Consent Items */
    .consent-banner {
        background: linear-gradient(135deg, var(--rk-accent) 0%, var(--rk-primary) 100%);
        color: var(--rk-white);
        padding: var(--space-6);
        border-radius: var(--radius-lg);
        margin-bottom: var(--space-8);
        display: flex;
        align-items: flex-start;
        gap: var(--space-5);
    }
    .consent-banner-icon { width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .consent-banner h3 { font-family: var(--font-display); font-size: 1.25rem; font-weight: 700; margin-bottom: var(--space-2); }
    .consent-banner p { opacity: 0.95; font-size: 0.9375rem; line-height: 1.6; }
    .consent-item {
        background: var(--rk-white);
        border: 2px solid var(--rk-gray-200);
        border-radius: var(--radius-md);
        padding: var(--space-5);
        margin-bottom: var(--space-4);
        cursor: pointer;
        transition: all var(--transition-fast);
        display: flex;
        gap: var(--space-4);
    }
    .consent-item:hover { border-color: var(--rk-gray-300); }
    .consent-item.selected { background: var(--rk-primary-light); border-color: var(--rk-primary); }
    .consent-item.error { border-color: var(--rk-error); background: var(--rk-error-bg); }
    .consent-checkbox {
        width: 24px; height: 24px; min-width: 24px;
        border: 2px solid var(--rk-gray-400);
        border-radius: var(--radius-sm);
        display: flex; align-items: center; justify-content: center;
        transition: all var(--transition-fast);
        margin-top: 2px;
    }
    .consent-item.selected .consent-checkbox { background: var(--rk-primary); border-color: var(--rk-primary); }
    .consent-checkbox svg { width: 14px; height: 14px; color: var(--rk-white); opacity: 0; transform: scale(0); transition: all var(--transition-fast); }
    .consent-item.selected .consent-checkbox svg { opacity: 1; transform: scale(1); }
    .consent-number { font-weight: 700; color: var(--rk-primary); margin-right: var(--space-2); }
    .consent-text { color: var(--rk-gray-700); line-height: 1.6; flex: 1; font-size: 0.9375rem; }
    .consent-text strong { color: var(--rk-gray-800); }
    .consent-text ul { margin: var(--space-3) 0 0 var(--space-5); color: var(--rk-gray-600); }
    .consent-text ul li { margin-bottom: var(--space-2); }

    /* Signature Section */
    .signature-section { background: linear-gradient(180deg, var(--rk-gray-50, #f9fafb) 0%, var(--rk-white) 100%); border: 2px solid var(--rk-gray-200); border-radius: var(--radius-lg); padding: var(--space-6); margin-top: var(--space-8); }
    .signature-title { font-size: 1.125rem; font-weight: 600; color: var(--rk-gray-800); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-3); }
    .signature-declaration { background: var(--rk-warning-bg); border: 1px solid var(--rk-warning); border-radius: var(--radius-md); padding: var(--space-4); margin-bottom: var(--space-5); font-size: 0.9375rem; color: var(--rk-gray-700); font-style: italic; line-height: 1.6; }
    .signature-grid { display: grid; grid-template-columns: 2fr 1.5fr 1fr; gap: var(--space-5); }
    @media (max-width: 768px) { .signature-grid { grid-template-columns: 1fr; } }
    .signature-input { font-family: 'Brush Script MT', 'Segoe Script', cursive; font-size: 1.75rem; color: var(--rk-gray-900); }

    /* Nav Completed State */
    .nav-item.completed { background: var(--rk-success-bg); }
    .nav-item.completed .nav-number { background: var(--rk-success); }
    .error-summary p { color: var(--rk-gray-700); }

    /* Utilities */
    .mt-4 { margin-top: var(--space-4); }
    .mt-6 { margin-top: var(--space-6); }
    .mb-4 { margin-bottom: var(--space-4); }
    .space-y-4 > * + * { margin-top: var(--space-4); }
    .space-y-6 > * + * { margin-top: var(--space-6); }

    /* Mobile Nav */
    @media (max-width: 1024px) {
        .section-nav { display: flex; flex-wrap: nowrap; overflow-x: auto; gap: var(--space-2); padding: var(--space-3); -webkit-overflow-scrolling: touch; }
        .nav-item { flex-shrink: 0; padding: var(--space-2) var(--space-3); margin-bottom: 0; }
        .nav-text { display: none; }
        .nav-number { width: 36px; height: 36px; font-size: 0.875rem; }
    }

    /* Local Authority Search Styles */
    .search-container { position: relative; }
    .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--rk-white);
        border: 2px solid var(--rk-gray-300);
        border-top: none;
        border-radius: 0 0 var(--radius-md) var(--radius-md);
        box-shadow: var(--shadow-lg);
        max-height: 250px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    .search-results.active { display: block; }
    .search-item {
        padding: var(--space-3) var(--space-4);
        cursor: pointer;
        transition: background 0.2s;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    .search-item:last-child { border-bottom: none; }
    .search-item:hover, .search-item.highlighted {
        background: var(--rk-primary-light);
        color: var(--rk-primary);
    }
    .search-item .match { font-weight: 700; color: var(--rk-primary); }

    /* Address Timeline Status */
    .timeline-status {
        background: var(--rk-white);
        border: 2px solid var(--rk-gray-200);
        border-radius: var(--radius-lg);
        padding: var(--space-5);
        margin-bottom: var(--space-6);
    }
    .timeline-status.complete { background: var(--rk-success-bg); border-color: var(--rk-success); }
    .timeline-status.incomplete { background: var(--rk-warning-bg); border-color: var(--rk-warning); }
    .timeline-header { display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-3); }
    .timeline-icon { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .timeline-status.complete .timeline-icon { background: var(--rk-success); color: var(--rk-white); }
    .timeline-status.incomplete .timeline-icon { background: var(--rk-warning); color: var(--rk-white); }
    .timeline-title { font-weight: 600; color: var(--rk-gray-800); }
    .timeline-text { font-size: 0.875rem; color: var(--rk-gray-700); }
    .timeline-text ul { margin: var(--space-2) 0 0 var(--space-5); }
    .timeline-text li { margin-bottom: var(--space-1); }

    /* Training Sections */
    .training-section { margin-bottom: var(--space-6); padding: var(--space-5); background: var(--rk-gray-50); border-radius: var(--radius-lg); border: 1px solid var(--rk-gray-200); }
    .training-section.hidden { display: none; }
    .training-details { margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--rk-gray-200); }
    .training-details.hidden { display: none; }

    @media (max-width: 768px) {
        .form-header { padding: var(--space-6); }
        .form-header h1 { font-size: 1.5rem; }
        .form-body { padding: var(--space-5); }
        .field-grid, .field-grid-2, .field-grid-3 { grid-template-columns: 1fr; }
    }
</style>
{% endblock %}

{% block content %}
<div class="form-grid">
    <aside class="sidebar">
        <div class="progress-card">
            <div class="progress-header"><span class="progress-title">Progress</span><span class="progress-percent" id="progressPercent">0%</span></div>
            <div class="progress-bar-container"><div class="progress-bar" id="progressBar"></div></div>
            <div class="progress-steps" id="progressSteps">Section 1 of 9</div>
        </div>

        <nav class="section-nav" id="sectionNav">
            <div class="nav-item active" data-section="0"><div class="nav-number">1</div><span class="nav-text">Personal Details</span></div>
            <div class="nav-item" data-section="1"><div class="nav-number">2</div><span class="nav-text">Address History</span></div>
            <div class="nav-item" data-section="2"><div class="nav-number">3</div><span class="nav-text">Premises</span></div>
            <div class="nav-item" data-section="3"><div class="nav-number">4</div><span class="nav-text">Your Service</span></div>
            <div class="nav-item" data-section="4"><div class="nav-number">5</div><span class="nav-text">Training</span></div>
            <div class="nav-item" data-section="5"><div class="nav-number">6</div><span class="nav-text">Employment</span></div>
            <div class="nav-item" data-section="6"><div class="nav-number">7</div><span class="nav-text">Household</span></div>
            <div class="nav-item" data-section="7"><div class="nav-number">8</div><span class="nav-text">Suitability</span></div>
            <div class="nav-item" data-section="8"><div class="nav-number">9</div><span class="nav-text">Declaration</span></div>
        </nav>
    </aside>

    <main class="form-container">
        <div class="form-header">
            <h1>Apply to register as a childminder</h1>
            <p>Complete this application to register with ReadyKids Childminder Agency.</p>
        </div>

        <div class="form-body">
            <div class="error-summary" id="errorSummary" role="alert" tabindex="-1">
                <div class="error-summary-header">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                    <h3>There is a problem</h3>
                </div>
                <p id="errorMessage">Please correct the errors below to continue.</p>
            </div>

            <form id="applicationForm" method="post" novalidate>
                {% csrf_token %}
                <input type="hidden" name="action" id="formAction" value="submit">
                <input type="hidden" name="current_section" id="currentSectionInput" value="0">

                <!-- SECTION 0: PERSONAL DETAILS -->
                <section class="form-section active" id="section-0">
                    <h2 class="section-title">Personal Details</h2>
                    <p class="section-description">We need your personal information to verify your identity and process your registration.</p>
                    <div class="field-grid field-grid-2">
                        <div class="field {% if personal_form.title.errors %}has-error{% endif %}">
                            <label class="field-label" for="id_personal-title">Title <span class="required">*</span></label>
                            {{ personal_form.title }}
                            {% if personal_form.title.errors %}<span class="field-error">{{ personal_form.title.errors.0 }}</span>{% endif %}
                        </div>
                        <div class="field {% if personal_form.first_name.errors %}has-error{% endif %}">
                            <label class="field-label" for="id_personal-first_name">First name(s) <span class="required">*</span></label>
                            {{ personal_form.first_name }}
                            {% if personal_form.first_name.errors %}<span class="field-error">{{ personal_form.first_name.errors.0 }}</span>{% endif %}
                        </div>
                        <div class="field {% if personal_form.middle_names.errors %}has-error{% endif %}">
                            <label class="field-label" for="id_personal-middle_names">Middle name(s)</label>
                            {{ personal_form.middle_names }}
                            {% if personal_form.middle_names.errors %}<span class="field-error">{{ personal_form.middle_names.errors.0 }}</span>{% endif %}
                        </div>
                        <div class="field {% if personal_form.last_name.errors %}has-error{% endif %}">
                            <label class="field-label" for="id_personal-last_name">Last name <span class="required">*</span></label>
                            {{ personal_form.last_name }}
                            {% if personal_form.last_name.errors %}<span class="field-error">{{ personal_form.last_name.errors.0 }}</span>{% endif %}
                        </div>
                    </div>

                    <div class="field">
                        <label class="field-label">Gender <span class="required">*</span></label>
                        <div class="radio-group horizontal">
                            <label class="radio-item">
                                <input type="radio" name="personal-gender" value="Male" {% if personal_form.gender.value == "Male" %}checked{% endif %} required>
                                <span class="radio-indicator"></span>
                                <span class="option-label">Male</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="personal-gender" value="Female" {% if personal_form.gender.value == "Female" %}checked{% endif %} required>
                                <span class="radio-indicator"></span>
                                <span class="option-label">Female</span>
                            </label>
                        </div>
                    </div>

                    <div class="field">
                        <label class="field-label">Have you ever been known by any other names? <span class="required">*</span></label>
                        <span class="field-hint">Including maiden names, previous married names, or name changes</span>
                        <div class="radio-group horizontal">
                            <label class="radio-item">
                                <input type="radio" name="personal-known_by_other_names" value="True" {% if personal_form.known_by_other_names.value == True %}checked{% endif %} required>
                                <span class="radio-indicator"></span>
                                <span class="option-label">Yes</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="personal-known_by_other_names" value="False" {% if personal_form.known_by_other_names.value == False %}checked{% endif %} required>
                                <span class="radio-indicator"></span>
                                <span class="option-label">No</span>
                            </label>
                        </div>
                    </div>

                    <div id="nameHistoryContainer" class="hidden">
                        <div id="previousNamesList" class="space-y-4"></div>
                        <button type="button" class="add-btn" id="addPreviousName">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            Add another name
                        </button>
                    </div>

                    <div class="field {% if personal_form.dob.errors %}has-error{% endif %}">
                        <label class="field-label" for="id_personal-dob">Date of birth <span class="required">*</span></label>
                        <span class="field-hint">You must be 18 or over to register as a childminder</span>
                        {{ personal_form.dob }}
                        {% if personal_form.dob.errors %}<span class="field-error">{{ personal_form.dob.errors.0 }}</span>{% endif %}
                    </div>

                    <div class="field {% if personal_form.right_to_work_status.errors %}has-error{% endif %}">
                        <label class="field-label">Do you have the right to work in the UK? <span class="required">*</span></label>
                        {{ personal_form.right_to_work_status }}
                        {% if personal_form.right_to_work_status.errors %}<span class="field-error">{{ personal_form.right_to_work_status.errors.0 }}</span>{% endif %}
                    </div>

                    <div id="rightToWorkInfo" class="info-box warning hidden">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                        <div class="info-box-content">
                            <h4>Right to Work Required</h4>
                            <p>We will need to verify your right to work status. If you do not have the right to work in the UK, we cannot proceed with your application.</p>
                        </div>
                    </div>

                    <div class="subsection">
                        <h3 class="subsection-title">Contact Details</h3>
                        <div class="field-grid field-grid-2">
                            <div class="field {% if personal_form.email.errors %}has-error{% endif %}">
                                <label class="field-label">Email address <span class="required">*</span></label>
                                {{ personal_form.email }}
                                {% if personal_form.email.errors %}<span class="field-error">{{ personal_form.email.errors.0 }}</span>{% endif %}
                            </div>
                            <div class="field {% if personal_form.phone.errors %}has-error{% endif %}">
                                <label class="field-label">Mobile number <span class="required">*</span></label>
                                {{ personal_form.phone }}
                                {% if personal_form.phone.errors %}<span class="field-error">{{ personal_form.phone.errors.0 }}</span>{% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="field {% if personal_form.ni_number.errors %}has-error{% endif %}">
                        <label class="field-label">National Insurance number <span class="required">*</span></label>
                        <div class="field-hint">It's on your National Insurance card, benefit letter, payslip or P60. For example, 'QQ 12 34 56 C'</div>
                        {{ personal_form.ni_number }}
                        {% if personal_form.ni_number.errors %}
                            {% for error in personal_form.ni_number.errors %}
                                <span class="field-error">{{ error }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="form-navigation">
                        <button type="button" class="btn btn-secondary save-exit-btn">Save and Exit</button>
                        <button type="button" class="btn btn-primary btn-lg next-btn">Continue</button>
                    </div>
                </section>

                <!-- SECTION 1: ADDRESS HISTORY -->
                <section class="form-section" id="section-1">
                    <h2 class="section-title">Address History</h2>
                    <p class="section-description">We need your complete address history for the past 5 years for background checks.</p>

                    <!-- History Overview -->
                    <div class="timeline-status incomplete" id="addressTimelineStatus">
                        <div class="timeline-header">
                            <div class="timeline-icon">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                            </div>
                            <h4 class="timeline-title" id="timelineTitle">Address history incomplete</h4>
                        </div>
                        <div class="timeline-text">
                            <p id="timelineText">You have provided <span id="addressYearsText">0 years</span> of history. We need 5 years total.</p>
                            <div id="addressGapsSection" class="hidden mt-4">
                                <strong>Gaps found:</strong>
                                <ul id="addressGapsList"></ul>
                            </div>
                        </div>
                    </div>

                    {{ address_formset.management_form }}
                    <div id="currentAddressSection">
                        <h3 class="subsection-title">Your Current Address</h3>
                        <div id="currentAddressContainer">
                            {% for form in address_formset %}
                                {% if forloop.first %}
                                    <div class="repeating-block current-address">
                                        {{ form.id }}
                                        <div class="field-grid field-grid-2">
                                            <div class="field full-width {% if form.line1.errors %}has-error{% endif %}">
                                                <label class="field-label">Address line 1 <span class="required">*</span></label>
                                                {{ form.line1 }}
                                                {% if form.line1.errors %}<span class="field-error">{{ form.line1.errors.0 }}</span>{% endif %}
                                            </div>
                                            <div class="field full-width {% if form.line2.errors %}has-error{% endif %}">
                                                <label class="field-label">Address line 2</label>
                                                {{ form.line2 }}
                                                {% if form.line2.errors %}<span class="field-error">{{ form.line2.errors.0 }}</span>{% endif %}
                                            </div>
                                            <div class="field {% if form.town.errors %}has-error{% endif %}">
                                                <label class="field-label">Town or city <span class="required">*</span></label>
                                                {{ form.town }}
                                                {% if form.town.errors %}<span class="field-error">{{ form.town.errors.0 }}</span>{% endif %}
                                            </div>
                                            <div class="field {% if form.postcode.errors %}has-error{% endif %}">
                                                <label class="field-label">Postcode <span class="required">*</span></label>
                                                {{ form.postcode }}
                                                {% if form.postcode.errors %}<span class="field-error">{{ form.postcode.errors.0 }}</span>{% endif %}
                                            </div>
                                            <div class="field {% if form.move_in_date.errors %}has-error{% endif %}">
                                                <label class="field-label">Date moved in <span class="required">*</span></label>
                                                {{ form.move_in_date }}
                                                {% if form.move_in_date.errors %}<span class="field-error">{{ form.move_in_date.errors.0 }}</span>{% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <div id="previousAddressSection">
                        <h3 class="subsection-title">Previous Addresses</h3>
                        <div id="addressHistoryContainer">
                            {% for form in address_formset %}
                                {% if not forloop.first %}
                                    <div class="repeating-block">
                                        <div class="repeating-block-header">
                                            <h3 class="repeating-block-title">Previous Address</h3>
                                            <button type="button" class="remove-btn">Remove</button>
                                        </div>
                                        {{ form.id }}
                                        <div class="field-grid field-grid-2">
                                            <div class="field full-width {% if form.line1.errors %}has-error{% endif %}">
                                                <label class="field-label">Address line 1 <span class="required">*</span></label>
                                                {{ form.line1 }}
                                                {% if form.line1.errors %}<span class="field-error">{{ form.line1.errors.0 }}</span>{% endif %}
                                            </div>
                                            <div class="field full-width {% if form.line2.errors %}has-error{% endif %}">
                                                <label class="field-label">Address line 2</label>
                                                {{ form.line2 }}
                                                {% if form.line2.errors %}<span class="field-error">{{ form.line2.errors.0 }}</span>{% endif %}
                                            </div>
                                            <div class="field {% if form.town.errors %}has-error{% endif %}">
                                                <label class="field-label">Town or city <span class="required">*</span></label>
                                                {{ form.town }}
                                                {% if form.town.errors %}<span class="field-error">{{ form.town.errors.0 }}</span>{% endif %}
                                            </div>
                                            <div class="field {% if form.postcode.errors %}has-error{% endif %}">
                                                <label class="field-label">Postcode <span class="required">*</span></label>
                                                {{ form.postcode }}
                                                {% if form.postcode.errors %}<span class="field-error">{{ form.postcode.errors.0 }}</span>{% endif %}
                                            </div>
                                            <div class="field-grid field-grid-2 full-width">
                                                <div class="field {% if form.move_in_date.errors %}has-error{% endif %}">
                                                    <label class="field-label">Date moved in <span class="required">*</span></label>
                                                    {{ form.move_in_date }}
                                                    {% if form.move_in_date.errors %}<span class="field-error">{{ form.move_in_date.errors.0 }}</span>{% endif %}
                                                </div>
                                                <div class="field {% if form.move_out_date.errors %}has-error{% endif %}">
                                                    <label class="field-label">Date moved out <span class="required">*</span></label>
                                                    {{ form.move_out_date }}
                                                    {% if form.move_out_date.errors %}<span class="field-error">{{ form.move_out_date.errors.0 }}</span>{% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <button type="button" class="add-btn" id="addAddressHistory">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            Add another previous address
                        </button>
                    </div>

                    <div class="subsection">
                        <h3 class="subsection-title">Overseas & Military History</h3>
                        
                        <div class="field">
                            <label class="field-label">Have you lived outside the UK in the last 5 years? <span class="required">*</span></label>
                            <div class="radio-group horizontal">
                                <label class="radio-item">
                                    <input type="radio" name="personal-lived_outside_uk" value="True" {% if personal_form.lived_outside_uk.value == True %}checked{% endif %} required>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">Yes</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="personal-lived_outside_uk" value="False" {% if personal_form.lived_outside_uk.value == False %}checked{% endif %} required>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">No</span>
                                </label>
                            </div>
                        </div>

                        <div id="outsideUKContainer" class="info-box info hidden">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                            <div class="info-box-content">
                                <p>If you have lived outside the UK, you must obtain a police check or 'Certificate of Good Conduct' from the relevant countries.</p>
                            </div>
                        </div>

                        <div class="field">
                            <label class="field-label">Have you lived or worked on a British military base abroad in the last 5 years? <span class="required">*</span></label>
                            <div class="radio-group horizontal">
                                <label class="radio-item">
                                    <input type="radio" name="personal-military_base_abroad" value="True" {% if personal_form.military_base_abroad.value == True %}checked{% endif %} required>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">Yes</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="personal-military_base_abroad" value="False" {% if personal_form.military_base_abroad.value == False %}checked{% endif %} required>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">No</span>
                                </label>
                            </div>
                        </div>

                        <div id="militaryBaseContainer" class="info-box info hidden">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                            <div class="info-box-content">
                                <p>We will arrange Ministry of Defence (MoD) checks on your behalf. You may need to complete additional forms.</p>
                            </div>
                        </div>
                    </div>
                    <div class="form-navigation">
                        <div style="display:flex; gap: 10px;">
                            <button type="button" class="btn btn-secondary prev-btn">Back</button>
                            <button type="button" class="btn btn-secondary save-exit-btn">Save and Exit</button>
                        </div>
                        <button type="button" class="btn btn-primary btn-lg next-btn">Continue</button>
                    </div>
                </section>

                <!-- SECTION 2: PREMISES -->
                <section class="form-section" id="section-2">
                    <h2 class="section-title">Childminding Premises</h2>
                    <p class="section-description">Tell us about the location where you will be providing childcare.</p>
                    <div class="subsection">
                        <h3 class="subsection-title">Local Authority</h3>
                        <div class="field">
                            <label class="field-label">Local authority <span class="required">*</span></label>
                            <div class="search-container">
                                {{ premises_form.local_authority }}
                                <div id="authorityResults" class="search-results"></div>
                            </div>
                            <span class="field-hint">Start typing your local authority name and select from the list.</span>
                        </div>
                    </div>
                    <div class="subsection">
                        <h3 class="subsection-title">Premises Type</h3>
                        <div class="field">
                            <label class="field-label">Premises type <span class="required">*</span></label>
                            <div class="radio-group horizontal">
                                <label class="radio-item">
                                    <input type="radio" name="premises-premises_type" value="Domestic" {% if premises_form.premises_type.value == "Domestic" %}checked{% endif %} required>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">Domestic (Home)</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="premises-premises_type" value="Non-domestic" {% if premises_form.premises_type.value == "Non-domestic" %}checked{% endif %} required>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">Non-domestic</span>
                                </label>
                            </div>
                        </div>

                        <div class="field">
                            <label class="field-label">Is this your home? <span class="required">*</span></label>
                            <div class="radio-group horizontal">
                                <label class="radio-item">
                                    <input type="radio" name="premises-is_own_home" value="True" {% if premises_form.is_own_home.value == True %}checked{% endif %} required>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">Yes</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="premises-is_own_home" value="False" {% if premises_form.is_own_home.value == False %}checked{% endif %} required>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">No</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="subsection">
                        <h3 class="subsection-title">Premises Details</h3>
                        <div class="field">
                            <label class="field-label">Outdoor space? <span class="required">*</span></label>
                            <div class="radio-group horizontal">
                                <label class="radio-item">
                                    <input type="radio" name="premises-has_outdoor_space" value="True" {% if premises_form.has_outdoor_space.value == True %}checked{% endif %} required>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">Yes</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="premises-has_outdoor_space" value="False" {% if premises_form.has_outdoor_space.value == False %}checked{% endif %} required>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">No</span>
                                </label>
                            </div>
                        </div>

                        <div class="field">
                            <label class="field-label">Do you have pets? <span class="required">*</span></label>
                            <div class="radio-group horizontal">
                                <label class="radio-item">
                                    <input type="radio" name="premises-has_pets" value="True" {% if premises_form.has_pets.value == True %}checked{% endif %} required>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">Yes</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="premises-has_pets" value="False" {% if premises_form.has_pets.value == False %}checked{% endif %} required>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">No</span>
                                </label>
                            </div>
                        </div>
                        <div class="field {% if not premises_form.has_pets.value %}hidden{% endif %}" id="pets-details-field"><label class="field-label">Details of pets</label>{{ premises_form.pets_details }}</div>
                    </div>
                    <div class="form-navigation">
                        <div style="display:flex; gap: 10px;">
                            <button type="button" class="btn btn-secondary prev-btn">Back</button>
                            <button type="button" class="btn btn-secondary save-exit-btn">Save and Exit</button>
                        </div>
                        <button type="button" class="btn btn-primary btn-lg next-btn">Continue</button>
                    </div>
                </section>

                <!-- SECTION 3: YOUR SERVICE -->
                <section class="form-section" id="section-3">
                    <h2 class="section-title">Your Childminding Service</h2>
                    <p class="section-description">Select which age groups you wish to care for. This determines your Ofsted register(s) and training requirements.</p>
 
                    <div class="subsection">
                        <h3 class="subsection-title">Age Groups</h3>
 
                        <div class="info-box info">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                            <div class="info-box-content">
                                <h4>Understanding the Registers</h4>
                                <p><strong>Early Years Register (0-5):</strong> Most comprehensive requirements.<br>
                                <strong>Compulsory Childcare Register (5-7):</strong> For children 5-8 years.<br>
                                <strong>Voluntary Childcare Register (8+):</strong> For children 8 and over.</p>
                            </div>
                        </div>
 
                        <div class="field"><label class="field-label">Which age groups will you care for? <span class="required">*</span></label>
                            <span class="field-hint">Select all that apply</span>
                            <div class="checkbox-group">
                                <label class="checkbox-item"><input type="checkbox" name="service-care_age_0_5" {% if service_form.care_age_0_5.value %}checked{% endif %}><span class="checkbox-indicator"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span><div class="option-content"><span class="option-label">05 years (Early Years Register)</span></div></label>
                                <label class="checkbox-item"><input type="checkbox" name="service-care_age_5_8" {% if service_form.care_age_5_8.value %}checked{% endif %}><span class="checkbox-indicator"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span><div class="option-content"><span class="option-label">57 years (Compulsory Childcare Register)</span></div></label>
                                <label class="checkbox-item"><input type="checkbox" name="service-care_age_8_plus" {% if service_form.care_age_8_plus.value %}checked{% endif %}><span class="checkbox-indicator"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span><div class="option-content"><span class="option-label">8 years or older (Voluntary Childcare Register)</span></div></label>
                            </div>
                        </div>
                    </div>

                    <div class="subsection">
                        <h3 class="subsection-title">Working Arrangements</h3>
                        <div class="field">
                            <label class="field-label">Will you work with any assistants or co-childminders? <span class="required">*</span></label>
                            <div class="radio-group horizontal">
                                <label class="radio-item">
                                    <input type="radio" name="service-work_with_assistants" value="True" {% if service_form.work_with_assistants.value == True %}checked{% endif %} required>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">Yes</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="service-work_with_assistants" value="False" {% if service_form.work_with_assistants.value == False %}checked{% endif %} required>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">No</span>
                                </label>
                            </div>
                        </div>
                        <div class="field {% if not service_form.work_with_assistants.value %}hidden{% endif %}" id="assistants-count-field"><label class="field-label">Number of assistants</label>{{ service_form.number_of_assistants }}</div>
                        
                        <div class="capacity-calculator">
                            <div class="capacity-header">
                                <div class="capacity-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>
                                <span class="capacity-title">Your Maximum Child Capacity</span>
                            </div>
                            <div class="capacity-grid">
                                <div class="capacity-card"><div class="capacity-number" id="totalAdultsText">1</div><div class="capacity-label">Total Adults</div></div>
                                <div class="capacity-card"><div class="capacity-number" id="maxUnder5Text">3</div><div class="capacity-label">Max Under 5s</div></div>
                                <div class="capacity-card"><div class="capacity-number" id="maxUnder1Text">1</div><div class="capacity-label">Max Under 1s</div></div>
                                <div class="capacity-card"><div class="capacity-number" id="maxUnder8Text">6</div><div class="capacity-label">Max Under 8s</div></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-navigation">
                        <div style="display:flex; gap: 10px;">
                            <button type="button" class="btn btn-secondary prev-btn">Back</button>
                            <button type="button" class="btn btn-secondary save-exit-btn">Save and Exit</button>
                        </div>
                        <button type="button" class="btn btn-primary btn-lg next-btn">Continue</button>
                    </div>
                </section>

                <!-- SECTION 4: TRAINING -->
                <!-- SECTION 4: QUALIFICATIONS & TRAINING -->
                <section class="form-section" id="section-4">
                    <h2 class="section-title">Qualifications & Training</h2>
                    <p class="section-description">You must have completed the required training before registration. We will verify certificates during your pre-registration visit.</p>

                    <div id="firstAidSection" class="training-section hidden">
                        <h3 style="font-weight: 600; margin-bottom: var(--space-3);">Paediatric First Aid (PFA)</h3>
                        <div class="field">
                            <label class="field-label">Have you completed a 12-hour Paediatric First Aid course? <span class="required">*</span></label>
                            <div class="radio-group horizontal">
                                <label class="radio-item">
                                    <input type="radio" name="training-first_aid_completed" value="True" {% if training_form.first_aid_completed.value == True %}checked{% endif %}>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">Yes</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="training-first_aid_completed" value="False" {% if training_form.first_aid_completed.value == False %}checked{% endif %}>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">No</span>
                                </label>
                            </div>
                        </div>
                        <div class="training-details {% if not training_form.first_aid_completed.value %}hidden{% endif %}" id="firstAidDetails">
                            <div class="field-grid field-grid-2">
                                <div class="field">
                                    <label class="field-label">Training organisation <span class="required">*</span></label>
                                    {{ training_form.first_aid_org }}
                                </div>
                                <div class="field">
                                    <label class="field-label">Date completed <span class="required">*</span></label>
                                    {{ training_form.first_aid_date }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="safeguardingSection" class="training-section hidden">
                        <h3 style="font-weight: 600; margin-bottom: var(--space-3);">Safeguarding and Child Protection</h3>
                        <div class="field">
                            <label class="field-label">Have you completed safeguarding training? <span class="required">*</span></label>
                            <div class="radio-group horizontal">
                                <label class="radio-item">
                                    <input type="radio" name="training-safeguarding_completed" value="True" {% if training_form.safeguarding_completed.value == True %}checked{% endif %}>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">Yes</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="training-safeguarding_completed" value="False" {% if training_form.safeguarding_completed.value == False %}checked{% endif %}>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">No</span>
                                </label>
                            </div>
                        </div>
                        <div class="training-details {% if not training_form.safeguarding_completed.value %}hidden{% endif %}" id="safeguardingDetails">
                            <div class="field-grid field-grid-2">
                                <div class="field">
                                    <label class="field-label">Training organisation <span class="required">*</span></label>
                                    {{ training_form.safeguarding_org }}
                                </div>
                                <div class="field">
                                    <label class="field-label">Date completed <span class="required">*</span></label>
                                    {{ training_form.safeguarding_date }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="eyfsSection" class="training-section hidden">
                        <h3 style="font-weight: 600; margin-bottom: var(--space-3);">Childminding Practice / EYFS Training</h3>
                        <div class="field">
                            <label class="field-label">Have you completed a relevant childminding course? <span class="required">*</span></label>
                            <div class="radio-group horizontal">
                                <label class="radio-item">
                                    <input type="radio" name="training-eyfs_completed" value="True" {% if training_form.eyfs_completed.value == True %}checked{% endif %}>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">Yes</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="training-eyfs_completed" value="False" {% if training_form.eyfs_completed.value == False %}checked{% endif %}>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">No</span>
                                </label>
                            </div>
                        </div>
                        <div class="training-details {% if not training_form.eyfs_completed.value %}hidden{% endif %}" id="eyfsDetails">
                            <div class="field">
                                <label class="field-label">Course title <span class="required">*</span></label>
                                {{ training_form.eyfs_course_title }}
                            </div>
                            <div class="field-grid field-grid-2">
                                <div class="field">
                                    <label class="field-label">Training organisation <span class="required">*</span></label>
                                    {{ training_form.eyfs_org }}
                                </div>
                                <div class="field">
                                    <label class="field-label">Date completed <span class="required">*</span></label>
                                    {{ training_form.eyfs_date }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="level2QualSection" class="training-section hidden">
                        <h3 style="font-weight: 600; margin-bottom: var(--space-3);">Level 2 Qualification / Common Core Skills</h3>
                        <div class="field">
                            <label class="field-label">Do you have a minimum Level 2 qualification OR training in the common core skills? <span class="required">*</span></label>
                            <div class="radio-group horizontal">
                                <label class="radio-item">
                                    <input type="radio" name="training-level2_qual_completed" value="True" {% if training_form.level2_qual_completed.value == True %}checked{% endif %}>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">Yes</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="training-level2_qual_completed" value="False" {% if training_form.level2_qual_completed.value == False %}checked{% endif %}>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">No</span>
                                </label>
                            </div>
                        </div>
                        <div class="training-details {% if not training_form.level2_qual_completed.value %}hidden{% endif %}" id="level2Details">
                            <div class="field-grid field-grid-2">
                                <div class="field">
                                    <label class="field-label">Training organisation <span class="required">*</span></label>
                                    {{ training_form.level2_qual_org }}
                                </div>
                                <div class="field">
                                    <label class="field-label">Date completed <span class="required">*</span></label>
                                    {{ training_form.level2_qual_date }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="training-section">
                        <h3 style="font-weight: 600; margin-bottom: var(--space-3);">Food Hygiene (Recommended)</h3>
                        <div class="field">
                            <label class="field-label">Have you completed food hygiene training?</label>
                            <span class="field-hint">Recommended if preparing food for children.</span>
                            <div class="radio-group horizontal">
                                <label class="radio-item">
                                    <input type="radio" name="training-food_hygiene_completed" value="True" {% if training_form.food_hygiene_completed.value == True %}checked{% endif %}>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">Yes</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="training-food_hygiene_completed" value="False" {% if training_form.food_hygiene_completed.value == False %}checked{% endif %}>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">No</span>
                                </label>
                            </div>
                        </div>
                        <div class="training-details {% if not training_form.food_hygiene_completed.value %}hidden{% endif %}" id="foodHygieneDetails">
                            <div class="field-grid field-grid-2">
                                <div class="field">
                                    <label class="field-label">Training organisation <span class="required">*</span></label>
                                    {{ training_form.food_hygiene_org }}
                                </div>
                                <div class="field">
                                    <label class="field-label">Date completed <span class="required">*</span></label>
                                    {{ training_form.food_hygiene_date }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="info-box info" id="trainingEmptyWarning">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                        <div class="info-box-content"><p>Please select your age groups to see required training.</p></div>
                    </div>

                    <div class="form-navigation">
                        <div style="display:flex; gap: 10px;">
                            <button type="button" class="btn btn-secondary prev-btn">Back</button>
                            <button type="button" class="btn btn-secondary save-exit-btn">Save and Exit</button>
                        </div>
                        <button type="button" class="btn btn-primary btn-lg next-btn">Continue</button>
                    </div>
                </section>

                <!-- SECTION 5: EMPLOYMENT -->
                <section class="form-section" id="section-5">
                    <h2 class="section-title">Employment & References</h2>
                    <p class="section-description">Provide your employment history and two professional references.</p>
                    {{ employment_formset.management_form }}
                    <div id="employmentHistoryContainer">
                        {% for form in employment_formset %}
                        <div class="repeating-block">
                            {{ form.id }}
                            <div class="repeating-block-header"><span class="repeating-block-title">Employment Entry</span>{% if not forloop.first %}<button type="button" class="remove-btn">Remove</button>{% endif %}</div>
                            <div class="field"><label class="field-label">Employer name <span class="required">*</span></label>{{ form.employer_name }}</div>
                            <div class="field-grid field-grid-2">
                                <div class="field"><label class="field-label">Job title <span class="required">*</span></label>{{ form.role }}</div>
                                <div class="field" style="display:flex; align-items:center; gap:10px; padding-top:20px;">{{ form.is_current }} <span>Current job?</span></div>
                            </div>
                            <div class="field-grid field-grid-2">
                                <div class="field"><label class="field-label">Start date <span class="required">*</span></label>{{ form.start_date }}</div>
                                <div class="field"><label class="field-label">End date</label>{{ form.end_date }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="add-btn" id="addEmploymentHistory">Add another job</button>
                    <div class="subsection">
                        <h3 class="subsection-title">References</h3>
                        {{ reference_formset.management_form }}
                        <div id="referenceContainer">
                            {% for form in reference_formset %}
                            <div class="repeating-block">
                                {{ form.id }}
                                <div class="repeating-block-header"><span class="repeating-block-title">Reference</span></div>
                                <div class="field-grid field-grid-2">
                                    <div class="field"><label class="field-label">First name <span class="required">*</span></label>{{ form.first_name }}</div>
                                    <div class="field"><label class="field-label">Last name <span class="required">*</span></label>{{ form.last_name }}</div>
                                </div>
                                <div class="field-grid field-grid-2">
                                    <div class="field"><label class="field-label">Email address <span class="required">*</span></label>{{ form.email }}</div>
                                    <div class="field"><label class="field-label">Phone number <span class="required">*</span></label>{{ form.phone }}</div>
                                </div>
                                <div class="field-grid field-grid-2">
                                    <div class="field"><label class="field-label">Relationship <span class="required">*</span></label>{{ form.relationship }}</div>
                                    <div class="field"><label class="field-label">Years known <span class="required">*</span></label>{{ form.years_known }}</div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <button type="button" class="add-btn" id="addReference">Add another reference</button>
                    </div>
                    <div class="form-navigation">
                        <div style="display:flex; gap: 10px;">
                            <button type="button" class="btn btn-secondary prev-btn">Back</button>
                            <button type="button" class="btn btn-secondary save-exit-btn">Save and Exit</button>
                        </div>
                        <button type="button" class="btn btn-primary btn-lg next-btn">Continue</button>
                    </div>
                </section>

                <!-- SECTION 6: HOUSEHOLD -->
                <section class="form-section" id="section-6">
                    <h2 class="section-title">Household Members</h2>
                    <p class="section-description">We need details of everyone living at the childcare premises.</p>
                    
                    {{ household_formset.management_form }}
                    
                    <div class="subsection">
                        <div class="field">
                            <label class="field-label">Do any other people aged 16 or over live or work at the premises? <span class="required">*</span></label>
                            <div class="radio-group horizontal">
                                <label class="radio-item">
                                    <input type="radio" name="application-has_adults_in_home" value="True" {% if application.has_adults_in_home %}checked{% endif %}>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">Yes</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="application-has_adults_in_home" value="False" {% if application.has_adults_in_home == False %}checked{% endif %}>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">No</span>
                                </label>
                            </div>
                        </div>
                        
                        <div id="adultsSection" class="{% if not application.has_adults_in_home %}hidden{% endif %}">
                            <h3 class="subsection-title">People aged 16 or over</h3>
                            <p class="field-hint mb-4">Include partners, older children, lodgers, or anyone who lives or works here regularly.</p>
                            
                            <div id="adultsContainer">
                                {% for form in household_formset %}
                                    <div class="repeating-block household-member-block" data-is-adult="{{ form.is_adult.value|default:'True' }}">
                                        {{ form.id }}
                                        <div class="repeating-block-header">
                                            <span class="repeating-block-title">Member</span>
                                            {% if not forloop.first %}<button type="button" class="remove-btn">Remove</button>{% endif %}
                                        </div>
                                        <div class="field-grid field-grid-2">
                                            <div class="field"><label class="field-label">First name <span class="required">*</span></label>{{ form.first_name }}</div>
                                            <div class="field"><label class="field-label">Last name <span class="required">*</span></label>{{ form.last_name }}</div>
                                        </div>
                                        <div class="field-grid field-grid-2">
                                            <div class="field"><label class="field-label">Date of birth <span class="required">*</span></label>{{ form.dob }}</div>
                                            <div class="field"><label class="field-label">Relationship <span class="required">*</span></label>{{ form.relationship }}</div>
                                        </div>
                                        <div class="field hidden">{{ form.is_adult }}</div>
                                    </div>
                                {% endfor %}
                            </div>
                            <button type="button" class="add-btn" id="addHouseholdMember">Add another person</button>
                        </div>
                    </div>

                    <div class="subsection">
                        <div class="field">
                            <label class="field-label">Does anyone under the age of 16 live at the premises? <span class="required">*</span></label>
                            <div class="radio-group horizontal">
                                <label class="radio-item">
                                    <input type="radio" name="application-has_children_in_home" value="True" {% if application.has_children_in_home %}checked{% endif %}>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">Yes</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="application-has_children_in_home" value="False" {% if application.has_children_in_home == False %}checked{% endif %}>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">No</span>
                                </label>
                            </div>
                        </div>
                        
                        <div id="childrenSection" class="{% if not application.has_children_in_home %}hidden{% endif %}">
                            <h3 class="subsection-title">Children under 16</h3>
                            <div id="childrenContainer">
                                <!-- Children will be moved here by JS if is_adult is False -->
                            </div>
                            <button type="button" class="add-btn" id="addChildMember">Add another child</button>
                        </div>
                    </div>

                    <div class="form-navigation">
                        <div style="display:flex; gap: 10px;">
                            <button type="button" class="btn btn-secondary prev-btn">Back</button>
                            <button type="button" class="btn btn-secondary save-exit-btn">Save and Exit</button>
                        </div>
                        <button type="button" class="btn btn-primary btn-lg next-btn">Continue</button>
                    </div>
                </section>

                <!-- SECTION 7: SUITABILITY -->
                <section class="form-section" id="section-7">
                    <h2 class="section-title">Suitability & DBS</h2>
                    <p class="section-description">Important declarations about your suitability to work with children.</p>
 
                    <div class="subsection">
                        <h3 class="subsection-title">Health Declaration</h3>
                        <div class="field">
                            <label class="field-label">Do you have any medical conditions? <span class="required">*</span></label>
                            <div class="radio-group horizontal">
                                <label class="radio-item">
                                    <input type="radio" name="suitability-has_medical_condition" value="True" {% if suitability_form.has_medical_condition.value == True %}checked{% endif %} required>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">Yes</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="suitability-has_medical_condition" value="False" {% if suitability_form.has_medical_condition.value == False %}checked{% endif %} required>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">No</span>
                                </label>
                            </div>
                        </div>
                        <div class="field {% if not suitability_form.has_medical_condition.value %}hidden{% endif %}" id="medical-details-field">
                            <label class="field-label">Details of medical conditions</label>
                            {{ suitability_form.medical_condition_details }}
                        </div>
                    </div>

                    <div class="subsection">
                        <h3 class="subsection-title">Legal Declarations</h3>
                        <div class="field">
                            <label class="field-label">Involved with social services? <span class="required">*</span></label>
                            <div class="radio-group horizontal">
                                <label class="radio-item">
                                    <input type="radio" name="suitability-social_services_involved" value="True" {% if suitability_form.social_services_involved.value == True %}checked{% endif %} required>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">Yes</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="suitability-social_services_involved" value="False" {% if suitability_form.social_services_involved.value == False %}checked{% endif %} required>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">No</span>
                                </label>
                            </div>
                        </div>
                        <div class="field {% if not suitability_form.social_services_involved.value %}hidden{% endif %}" id="social-services-field">
                            <label class="field-label">Details of involvement</label>
                            {{ suitability_form.social_services_details }}
                        </div>

                        <div class="field">
                            <label class="field-label">Are you disqualified under the Childcare Act 2006? <span class="required">*</span></label>
                            <div class="radio-group horizontal">
                                <label class="radio-item">
                                    <input type="radio" name="suitability-is_disqualified" value="True" {% if suitability_form.is_disqualified.value == True %}checked{% endif %} required>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">Yes</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="suitability-is_disqualified" value="False" {% if suitability_form.is_disqualified.value == False %}checked{% endif %} required>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">No</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="subsection">
                        <h3 class="subsection-title">DBS Certificate</h3>
                        <div class="field">
                            <label class="field-label">Do you have an Enhanced DBS? <span class="required">*</span></label>
                            <div class="radio-group horizontal">
                                <label class="radio-item">
                                    <input type="radio" name="suitability-has_dbs" value="True" {% if suitability_form.has_dbs.value == True %}checked{% endif %} required>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">Yes</span>
                                </label>
                                <label class="radio-item">
                                    <input type="radio" name="suitability-has_dbs" value="False" {% if suitability_form.has_dbs.value == False %}checked{% endif %} required>
                                    <span class="radio-indicator"></span>
                                    <span class="option-label">No</span>
                                </label>
                            </div>
                        </div>
                        <div class="field {% if not suitability_form.has_dbs.value %}hidden{% endif %}" id="dbs-number-field">
                            <label class="field-label">DBS certificate number <span class="required">*</span></label>
                            {{ suitability_form.dbs_number }}
                        </div>
                    </div>
                    <div class="form-navigation">
                        <div style="display:flex; gap: 10px;">
                            <button type="button" class="btn btn-secondary prev-btn">Back</button>
                            <button type="button" class="btn btn-secondary save-exit-btn">Save and Exit</button>
                        </div>
                        <button type="button" class="btn btn-primary btn-lg next-btn">Continue</button>
                    </div>
                </section>

                <!-- SECTION 8: DECLARATION -->
                <section class="form-section" id="section-8">
                    <h2 class="section-title">Local Authority Consent & Declaration</h2>
                    <p class="section-description">As part of safeguarding requirements, we must check with local authorities where you have lived in the past 5 years.</p>
 
                    <div class="consent-banner">
                        <div class="consent-banner-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div>
                        <div>
                            <h3>Why is this consent needed?</h3>
                            <p>ReadyKids is an Ofsted-registered childminder agency. We must carry out background checks with local authorities where you have lived to assess your suitability to work with children.</p>
                        </div>
                    </div>
 
                    <div class="subsection">
                        <h3 class="subsection-title">Your Consent</h3>
                        <p style="margin-bottom: var(--space-5); color: var(--rk-gray-700);">By checking each box below, you confirm that you:</p>
                        
                        <label class="consent-item"><input type="checkbox" name="declaration-consent_auth_contact" required><span class="consent-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span><span class="consent-text"><span class="consent-number">1.</span> <strong>Authorise ReadyKids</strong> to contact the children's services departments of any local authority area in which you have lived in the last 5 years.</span></label>
                        <label class="consent-item"><input type="checkbox" name="declaration-consent_auth_share" required><span class="consent-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span><span class="consent-text"><span class="consent-number">2.</span> <strong>Authorise those local authorities</strong> to share with ReadyKids any relevant information about your suitability to work with children.</span></label>
                        <label class="consent-item"><input type="checkbox" name="declaration-consent_understand_usage" required><span class="consent-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span><span class="consent-text"><span class="consent-number">3.</span> <strong>Understand</strong> that ReadyKids will use this information only for assessing your suitability and meeting safeguarding duties.</span></label>
                        <label class="consent-item"><input type="checkbox" name="declaration-consent_understand_gdpr" required><span class="consent-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span><span class="consent-text"><span class="consent-number">4.</span> <strong>Understand</strong> that ReadyKids will handle all information in accordance with data protection law.</span></label>
                        <label class="consent-item"><input type="checkbox" name="declaration-consent_truth" required><span class="consent-checkbox"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span><span class="consent-text"><span class="consent-number">5.</span> <strong>Confirm</strong> that all information in this application is true and complete to the best of your knowledge.</span></label>
                    </div>
 
                    <div class="signature-section">
                        <h3 class="signature-title"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg> Declaration & Signature</h3>
                        <div class="signature-declaration">I have read and understood the information above and I give my consent for ReadyKids and relevant local authority children's services departments to share information about me for the purposes described.</div>
                        <div class="signature-grid">
                            <div class="field"><label class="field-label">Your signature <span class="required">*</span></label><span class="field-hint">Type your full name as your electronic signature</span>{{ declaration_form.signature }}</div>
                            <div class="field"><label class="field-label">Full name (PRINT) <span class="required">*</span></label>{{ declaration_form.print_name }}</div>
                            <div class="field"><label class="field-label">Date <span class="required">*</span></label>{{ declaration_form.date_signed }}</div>
                        </div>
                    </div>
 
                    <div class="form-navigation">
                        <div style="display:flex; gap: 10px;">
                            <button type="button" class="btn btn-secondary prev-btn">Back</button>
                            <button type="button" class="btn btn-secondary save-exit-btn">Save and Exit</button>
                        </div>
                        <button type="submit" class="btn btn-primary btn-lg">Submit Application</button>
                    </div>
                </section>
            </form>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script>
    (function() {
        let currentSection = 0;
        const sections = document.querySelectorAll('.form-section');
        const navItems = document.querySelectorAll('.nav-item');
        const progressBar = document.getElementById('progressBar');
        const progressPercent = document.getElementById('progressPercent');
        const progressSteps = document.getElementById('progressSteps');
        const errorSummary = document.getElementById('errorSummary'); // Make sure this element exists or add it
        const errorMessage = document.getElementById('errorMessage');

        function updateProgress() {
            const percent = Math.round((currentSection / (sections.length - 1)) * 100);
            if (progressBar) progressBar.style.width = percent + '%';
            if (progressPercent) progressPercent.textContent = percent + '%';
            if (progressSteps) progressSteps.textContent = `Section ${currentSection + 1} of ${sections.length}`;
        }

        function showSection(index) {
            if (index < 0 || index >= sections.length) return;

            // Validate when going forward
            if (index > currentSection) {
                const validation = validateSection(currentSection);
                if (!validation.isValid) {
                    if (errorMessage) errorMessage.textContent = validation.message;
                    if (errorSummary) {
                        errorSummary.classList.add('active');
                        errorSummary.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else {
                        alert(validation.message);
                    }
                    return;
                }
            }

            if (errorSummary) errorSummary.classList.remove('active');
            sections.forEach(s => s.classList.remove('active'));
            navItems.forEach(n => n.classList.remove('active'));
            
            sections[index].classList.add('active');
            navItems[index].classList.add('active');
            
            // Mark previous as completed
            navItems.forEach((n, i) => {
                if (i < index) n.classList.add('completed');
                else n.classList.remove('completed');
            });

            currentSection = index;
            updateProgress();
            window.scrollTo(0, 0);
        }

        function validateSection(index) {
            const section = sections[index];
            let hasErrors = false;
            let errorMessages = [];
            
            // Clear previous errors
            section.querySelectorAll('.error').forEach(el => el.classList.remove('error'));

            // Age validation for Section 0
            if (index === 0) {
                const dobInput = document.getElementById('id_personal-dob');
                if (dobInput && dobInput.value) {
                    const birthDate = new Date(dobInput.value);
                    const today = new Date();
                    let age = today.getFullYear() - birthDate.getFullYear();
                    const m = today.getMonth() - birthDate.getMonth();
                    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
                    if (age < 18) {
                        dobInput.classList.add('error');
                        return { isValid: false, message: 'You must be 18 or over to register as a childminder.' };
                    }
                }
            }

            // Section 3 (Your Service): require at least one age group
            if (index === 3) {
                const ageCheckboxes = section.querySelectorAll('input[name^="service-care_age"]');
                const anyChecked = Array.from(ageCheckboxes).some(cb => cb.checked);
                if (!anyChecked) {
                    ageCheckboxes.forEach(cb => cb.closest('.checkbox-item')?.classList.add('error'));
                    return { isValid: false, message: 'Please select at least one age group you will care for.' };
                }
            }

            // Section 5 (Employment & References): validate years_known is non-negative
            if (index === 5) {
                const yearsInputs = section.querySelectorAll('input[name$="-years_known"]');
                for (const input of yearsInputs) {
                    if (input.value !== '' && parseInt(input.value) < 0) {
                        input.classList.add('error');
                        return { isValid: false, message: 'Years known cannot be negative.' };
                    }
                }
            }

            // Check required fields
            const requiredFields = section.querySelectorAll('[required]');
            let missingFields = [];
            
            requiredFields.forEach(field => {
                // Check visibility
                if (field.offsetParent === null) return;
                
                let isInvalid = false;
                let fieldLabel = "";
                const labelEl = field.closest('.field')?.querySelector('.field-label');
                if (labelEl) fieldLabel = labelEl.textContent.replace('*', '').trim();
                else fieldLabel = field.placeholder || field.name;

                if (field.type === 'radio') {
                    const group = section.querySelectorAll(`input[name="${field.name}"]`);
                    const checked = Array.from(group).some(r => r.checked);
                    if (!checked) {
                        isInvalid = true;
                        group.forEach(r => r.closest('.radio-item')?.classList.add('error'));
                    }
                } else if (field.type === 'checkbox') {
                    if (!field.checked) {
                        isInvalid = true;
                        field.closest('.checkbox-item, .consent-item')?.classList.add('error');
                    }
                } else {
                    if (!field.value.trim()) {
                        isInvalid = true;
                        field.classList.add('error');
                    }
                }
                
                if (isInvalid) {
                    hasErrors = true;
                    if (fieldLabel && !missingFields.includes(fieldLabel)) missingFields.push(fieldLabel);
                }
            });

            if (hasErrors) {
                let msg = 'Please fill in all required fields';
                if (missingFields.length > 0) {
                    msg += ': ' + missingFields.join(', ');
                }
                return { isValid: false, message: msg };
            }
            return { isValid: true };
        }

        // Navigation Events
        document.querySelectorAll('.next-btn').forEach(btn => 
            btn.addEventListener('click', () => {
                // Validate when going forward
                const validation = validateSection(currentSection);
                if (!validation.isValid) {
                    if (errorMessage) errorMessage.textContent = validation.message;
                    if (errorSummary) {
                        errorSummary.classList.add('active');
                        errorSummary.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else {
                         alert(validation.message);
                    }
                    return;
                }
                
                if (errorSummary) errorSummary.classList.remove('active');
                showSection(currentSection + 1);
            })
        );
        document.querySelectorAll('.prev-btn').forEach(btn => 
            btn.addEventListener('click', () => showSection(currentSection - 1))
        );
        navItems.forEach((item, index) => {
            item.addEventListener('click', () => {
                if (index <= currentSection) showSection(index);
            });
        });

        // Save and Exit button logic
        document.querySelectorAll('.save-exit-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const actionInput = document.getElementById('formAction');
                const sectionInput = document.getElementById('currentSectionInput');
                if (actionInput) actionInput.value = 'save_and_exit';
                if (sectionInput) sectionInput.value = currentSection;
                
                // Submit form without validation
                if (applicationForm) applicationForm.submit();
            });
        });

        // Form Submit Validation
        const applicationForm = document.getElementById('applicationForm');
        if (applicationForm) {
            applicationForm.addEventListener('submit', (e) => {
                const validation = validateSection(currentSection);
                if (!validation.isValid) {
                    e.preventDefault();
                    if (errorMessage) errorMessage.textContent = validation.message;
                    if (errorSummary) {
                        errorSummary.classList.add('active');
                        errorSummary.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else {
                        alert(validation.message);
                    }
                }
            });
        }

        // Radio & Checkbox Interactions (Visual State)
        document.querySelectorAll('.radio-item, .checkbox-item, .consent-item').forEach(item => {
            const input = item.querySelector('input');
            if (!input) return;

            // Initial State
            if (input.checked) item.classList.add('selected');

            // Click Handler
            item.addEventListener('click', (e) => {
                // If the user clicked the actual input, let the browser handle it.
                // The 'change' event listener below will catch it.
                if (e.target === input) return;
                
                // If they clicked the label/container, we manually toggle
                // and then prevent default to avoid double-toggle (label-click native behavior).
                e.preventDefault();
                
                if (input.type === 'radio') {
                    if (!input.checked) {
                        input.checked = true;
                        input.dispatchEvent(new Event('change', { bubbles: true }));
                    }
                } else {
                    input.checked = !input.checked;
                    input.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });

            // Listen for changes from other sources (like direct clicks)
            input.addEventListener('change', () => {
                if (input.type === 'radio') {
                     document.querySelectorAll(`input[name="${input.name}"]`).forEach(r => {
                        const parent = r.closest('.radio-item');
                        if (parent) parent.classList.toggle('selected', r.checked);
                    });
                } else {
                    item.classList.toggle('selected', input.checked);
                }
            });
        });


        // Address History Year Calculator
        function updateAddressHistory() {
            const addressEntries = document.querySelectorAll('#section-1 .repeating-block');
            const today = new Date();
            const fiveYearsAgo = new Date();
            fiveYearsAgo.setFullYear(today.getFullYear() - 5);
            
            let addresses = [];
            addressEntries.forEach(entry => {
                const moveInInput = entry.querySelector('input[name$="-move_in_date"]');
                const moveOutInput = entry.querySelector('input[name$="-move_out_date"]');
                
                if (moveInInput && moveInInput.value) {
                    const moveIn = new Date(moveInInput.value);
                    let moveOut = today;
                    if (moveOutInput && moveOutInput.value) {
                        moveOut = new Date(moveOutInput.value);
                    } else if (!entry.classList.contains('current-address')) {
                        // If not the current address and no move out date, it's invalid but we'll treat as today for calc
                        moveOut = today;
                    }

                    if (!isNaN(moveIn.getTime()) && !isNaN(moveOut.getTime())) {
                        addresses.push({ moveIn, moveOut, entry });
                    }
                }
            });

            // Sort by moveIn ascending
            addresses.sort((a, b) => a.moveIn - b.moveIn);

            let totalDays = 0;
            let gaps = [];
            let coveredIntervals = [];

            if (addresses.length > 0) {
                 // Check for overlaps and gaps
                 for (let i = 0; i < addresses.length; i++) {
                     const addr = addresses[i];
                     const start = addr.moveIn < fiveYearsAgo ? fiveYearsAgo : addr.moveIn;
                     const end = addr.moveOut;

                     if (end > start) {
                         coveredIntervals.push({ start, end });
                     }

                     if (i > 0) {
                         const prevEnd = addresses[i-1].moveOut;
                         const nextStart = addresses[i].moveIn;
                         const diff = (nextStart - prevEnd) / (1000 * 60 * 60 * 24);
                         if (diff > 2) { // Allow 2 days for margin of error
                             gaps.push({ start: prevEnd, end: nextStart });
                         }
                     }
                 }

                 // Merge intervals and calculate total coverage
                 if (coveredIntervals.length > 0) {
                     coveredIntervals.sort((a, b) => a.start - b.start);
                     let merged = [coveredIntervals[0]];
                     for (let i = 1; i < coveredIntervals.length; i++) {
                         let last = merged[merged.length - 1];
                         let curr = coveredIntervals[i];
                         if (curr.start <= last.end) {
                             last.end = new Date(Math.max(last.end, curr.end));
                         } else {
                             merged.push(curr);
                         }
                     }
                     
                     let totalDiff = 0;
                     merged.forEach(interval => {
                         totalDiff += (interval.end - interval.start);
                     });
                     totalDays = totalDiff / (1000 * 60 * 60 * 24);
                 }
            }

            const totalYears = (totalDays / 365.25).toFixed(1);

            // UI Update
            const statusBox = document.getElementById('addressTimelineStatus');
            const title = document.getElementById('timelineTitle');
            const text = document.getElementById('timelineText');
            const gapsSection = document.getElementById('addressGapsSection');
            const gapsList = document.getElementById('addressGapsList');

            const isFullCoverage = totalYears >= 5.0;
            const hasGaps = gaps.length > 0;
            const isComplete = isFullCoverage && !hasGaps;
            
            if (statusBox) {
                statusBox.className = `timeline-status ${isComplete ? 'complete' : 'incomplete'}`;
            }
            if (title) {
                title.textContent = isComplete ? 'Address history complete' : 'Address history incomplete';
            }
            if (text) {
                text.innerHTML = `You have provided <strong>${totalYears} years</strong> of history. We need 5 years total.`;
            }

            if (gapsSection && gapsList) {
                if (hasGaps) {
                    gapsSection.classList.remove('hidden');
                    gapsList.innerHTML = gaps.map(g => `<li>Gap from ${g.start.toLocaleDateString('en-GB', {month:'short', year:'numeric'})} to ${g.end.toLocaleDateString('en-GB', {month:'short', year:'numeric'})}</li>`).join('');
                } else {
                    gapsSection.classList.add('hidden');
                }
            }
        }

        // Existing FormSet & Toggle Logic preserved
        function setupFormSet(containerId, addBtnId, prefix, onChangeCallback) {
            const container = document.getElementById(containerId);
            const addBtn = document.getElementById(addBtnId);
            const totalForms = document.getElementById(`id_${prefix}-TOTAL_FORMS`);

            function updateLabels() {
                container.querySelectorAll('.repeating-block').forEach((block, idx) => {
                    const title = block.querySelector('.repeating-block-title');
                    if (title && !title.textContent.includes('Current')) {
                        title.textContent = title.textContent.replace(/\d+$/, '') + (idx + 1);
                    }
                });
            }

            container.addEventListener('click', e => {
                if (e.target.classList.contains('remove-btn')) {
                    e.target.closest('.repeating-block').remove();
                    totalForms.value = container.querySelectorAll('.repeating-block').length;
                    updateLabels();
                    if (onChangeCallback) onChangeCallback();
                }
            });

            if (addBtn) addBtn.addEventListener('click', () => {
                const formNum = parseInt(totalForms.value);
                const blocks = container.querySelectorAll('.repeating-block');
                const lastForm = blocks[blocks.length - 1];
                if (!lastForm) return; 
                const newForm = lastForm.cloneNode(true);
                newForm.innerHTML = newForm.innerHTML.replace(new RegExp(`${prefix}-\\d+-`, 'g'), `${prefix}-${formNum}-`);
                newForm.querySelectorAll('input, select, textarea').forEach(i => { 
                    if (i.name && i.name.endsWith('-id')) {
                        i.value = '';
                    } else if (i.type !== 'hidden') {
                        i.value = '';
                    }
                });
                if (!newForm.querySelector('.remove-btn')) {
                    const header = newForm.querySelector('.repeating-block-header');
                    const btn = document.createElement('button'); btn.type = 'button'; btn.className = 'remove-btn'; btn.textContent = 'Remove';
                    header.appendChild(btn);
                }
                container.appendChild(newForm);
                totalForms.value = formNum + 1;
                updateLabels();
                if (onChangeCallback) onChangeCallback();
            });
        }

        setupFormSet('addressHistoryContainer', 'addAddressHistory', 'address', updateAddressHistory);
        setupFormSet('employmentHistoryContainer', 'addEmploymentHistory', 'employment');
        setupFormSet('referenceContainer', 'addReference', 'reference');

        function setupToggle(triggerName, targetId, showValue = 'True') {
            const update = () => {
                const trigger = document.querySelector(`[name="${triggerName}"]`);
                const target = document.getElementById(targetId);
                if (target) {
                    let value;
                    if (!trigger) return; // Safety check
                    if (trigger.type === 'checkbox') {
                         value = trigger.checked ? 'True' : 'False';
                    } else if (trigger.type === 'radio' || (document.querySelectorAll(`[name="${triggerName}"]`).length > 1)) {
                         const checked = document.querySelector(`input[name="${triggerName}"]:checked`);
                         value = checked ? checked.value : '';
                    } else {
                         value = trigger.value;
                    }
                    if (value === showValue) target.classList.remove('hidden');
                    else target.classList.add('hidden');
                }
            };
            
            document.querySelectorAll(`[name="${triggerName}"]`).forEach(el => el.addEventListener('change', update));
            update();
        }

        // Section 6 Household Toggles
        setupToggle('application-has_adults_in_home', 'adultsSection');
        setupToggle('application-has_children_in_home', 'childrenSection');

        function organizeHouseholdMembers() {
            const adultsContainer = document.getElementById('adultsContainer');
            const childrenContainer = document.getElementById('childrenContainer');
            if (!adultsContainer || !childrenContainer) return;
            
            document.querySelectorAll('.household-member-block').forEach(block => {
                const isAdultInput = block.querySelector('input[name$="-is_adult"]');
                if (!isAdultInput) return;
                const isAdult = isAdultInput.value === 'True';
                if (isAdult) {
                    adultsContainer.appendChild(block);
                } else {
                    childrenContainer.appendChild(block);
                }
            });
        }
        
        organizeHouseholdMembers();

        function setupHouseholdButtons() {
            const addAdultBtn = document.getElementById('addHouseholdMember');
            const addChildBtn = document.getElementById('addChildMember');
            const totalForms = document.getElementById(`id_household-TOTAL_FORMS`);
            const adultsContainer = document.getElementById('adultsContainer');
            const childrenContainer = document.getElementById('childrenContainer');
            
            if (!addAdultBtn || !addChildBtn || !totalForms) return;

            function createMember(isAdult) {
                const formNum = parseInt(totalForms.value);
                const blocks = document.querySelectorAll('.household-member-block');
                // Use the first block as template if possible, or any existing one
                const templateBlock = blocks[0];
                if (!templateBlock) return; 
                
                const newForm = templateBlock.cloneNode(true);
                newForm.innerHTML = newForm.innerHTML.replace(/household-\d+-/g, `household-${formNum}-`);
                newForm.querySelectorAll('input, select, textarea').forEach(i => { 
                    if (i.name && i.name.endsWith('-id')) {
                        i.value = '';
                    } else if (i.type !== 'hidden') {
                        i.value = '';
                    }
                });
                
                // Set is_adult
                const isAdultInput = newForm.querySelector('input[name$="-is_adult"]');
                if (isAdultInput) isAdultInput.value = isAdult ? 'True' : 'False';
                
                // Ensure remove button exists
                if (!newForm.querySelector('.remove-btn')) {
                    const header = newForm.querySelector('.repeating-block-header');
                    const btn = document.createElement('button'); btn.type = 'button'; btn.className = 'remove-btn'; btn.textContent = 'Remove';
                    header.appendChild(btn);
                }
                
                if (isAdult) adultsContainer.appendChild(newForm);
                else childrenContainer.appendChild(newForm);
                
                totalForms.value = formNum + 1;
                
                // Re-bind radio interactions for new elements
                applyRadioInteractions(newForm);
            }

            function applyRadioInteractions(block) {
                 block.querySelectorAll('.radio-item, .checkbox-item').forEach(item => {
                    const input = item.querySelector('input');
                    item.addEventListener('click', (e) => {
                        if (e.target === input) return;
                        if (input.type === 'radio') {
                            const groupName = input.name;
                            document.querySelectorAll(`input[name="${groupName}"]`).forEach(r => {
                                r.closest('.radio-item')?.classList.remove('selected');
                            });
                            input.checked = true;
                            item.classList.add('selected');
                        } else {
                            input.checked = !input.checked;
                            item.classList.toggle('selected', input.checked);
                        }
                        input.dispatchEvent(new Event('change', { bubbles: true }));
                    });
                });
            }

            addAdultBtn.addEventListener('click', () => createMember(true));
            addChildBtn.addEventListener('click', () => createMember(false));
            
            // Re-bind remove for BOTH containers
            [adultsContainer, childrenContainer].forEach(container => {
                container.addEventListener('click', e => {
                    if (e.target.classList.contains('remove-btn')) {
                        e.target.closest('.repeating-block').remove();
                        totalForms.value = document.querySelectorAll('.household-member-block').length;
                    }
                });
            });
        }
        
        setupHouseholdButtons();

        // Personal Details Toggles
        setupToggle('personal-known_by_other_names', 'nameHistoryContainer', 'True');
        setupToggle('personal-lived_outside_uk', 'outsideUKContainer', 'True');
        setupToggle('personal-military_base_abroad', 'militaryBaseContainer', 'True');

        // Service Toggles
        setupToggle('service-work_with_assistants', 'assistants-count-field', 'True');

        // Premises Toggles
        setupToggle('premises-has_pets', 'pets-details-field');
        setupToggle('premises-has_outdoor_space', 'outdoor-space-field');
        setupToggle('premises-is_own_home', 'not-own-home-field', 'False');

        // Suitability Toggles
        setupToggle('suitability-has_medical_condition', 'medical-details-field');
        setupToggle('suitability-social_services_involved', 'social-services-field');
        setupToggle('suitability-has_dbs', 'dbs-number-field');
        
        // Training sub-toggles
        setupToggle('training-first_aid_completed', 'firstAidDetails');
        setupToggle('training-safeguarding_completed', 'safeguardingDetails');
        setupToggle('training-eyfs_completed', 'eyfsDetails');
        setupToggle('training-level2_qual_completed', 'level2Details');
        setupToggle('training-food_hygiene_completed', 'foodHygieneDetails');
        // 
        // AGE GROUP TRAINING REQUIREMENTS
        // 
        function handleAgeGroupChange() {
            const is0to5 = document.querySelector('input[name="service-care_age_0_5"]')?.checked;
            const is5to7 = document.querySelector('input[name="service-care_age_5_8"]')?.checked;
            const is8plus = document.querySelector('input[name="service-care_age_8_plus"]')?.checked;

            const firstAid = document.getElementById('firstAidSection');
            const safeguarding = document.getElementById('safeguardingSection');
            const eyfs = document.getElementById('eyfsSection');
            const level2 = document.getElementById('level2QualSection');
            const warning = document.getElementById('trainingEmptyWarning');

            // Logic:
            // 0-5: Needs PFA and EYFS and Safeguarding
            // 5-8 or 8+: Needs Safeguarding and Level 2
            
            let anySelected = false;
            
            if (is0to5) {
                firstAid?.classList.remove('hidden');
                eyfs?.classList.remove('hidden');
                safeguarding?.classList.remove('hidden');
                level2?.classList.add('hidden');
                anySelected = true;
            } else if (is5to7 || is8plus) {
                firstAid?.classList.add('hidden');
                eyfs?.classList.add('hidden');
                safeguarding?.classList.remove('hidden');
                level2?.classList.remove('hidden');
                anySelected = true;
            } else {
                firstAid?.classList.add('hidden');
                eyfs?.classList.add('hidden');
                safeguarding?.classList.add('hidden');
                level2?.classList.add('hidden');
            }

            if (warning) {
                if (anySelected) warning.classList.add('hidden');
                else warning.classList.remove('hidden');
            }
        }

        document.querySelectorAll('input[name^="service-care_age_"]').forEach(cb => {
            cb.addEventListener('change', handleAgeGroupChange);
        });
        // Run once on load
        handleAgeGroupChange();
        
        // 
        // REPEATING BLOCKS
        // 
        function createRepeatingBlock(containerId, templateFn, addBtnId, onAdd, onRemove) {
            const container = document.getElementById(containerId);
            const addBtn = document.getElementById(addBtnId);
            if (!container || !addBtn) return;

            function addBlock() {
                const index = container.children.length;
                const block = document.createElement('div');
                block.className = 'repeating-block';
                block.innerHTML = templateFn(index);
                container.appendChild(block);

                block.querySelector('.remove-btn')?.addEventListener('click', () => {
                    block.remove();
                    if (onRemove) onRemove();
                });

                // Re-apply radio/checkbox styling for new elements
                block.querySelectorAll('.radio-item, .checkbox-item').forEach(item => {
                    const input = item.querySelector('input');
                    item.addEventListener('click', (e) => {
                        if (e.target === input) return;
                        if (input.type === 'radio') {
                             // Correctly scope to the name group within this block or globally
                            const groupName = input.name;
                            document.querySelectorAll(`input[name="${groupName}"]`).forEach(r => {
                                r.closest('.radio-item')?.classList.remove('selected');
                            });
                            input.checked = true;
                            item.classList.add('selected');
                        } else {
                            input.checked = !input.checked;
                            item.classList.toggle('selected', input.checked);
                        }
                        input.dispatchEvent(new Event('change', { bubbles: true }));
                    });
                });

                if (onAdd) onAdd(block);
                return block;
            }

            addBtn.addEventListener('click', addBlock);
            return { addBlock };
        }

        // Previous Names
        createRepeatingBlock('previousNamesList', (i) => `
            <div class="repeating-block-header"><span class="repeating-block-title">Previous Name ${i+1}</span><button type="button" class="remove-btn">Remove</button></div>
            <div class="field-grid field-grid-2">
                <div class="field full-width"><label class="field-label">Full name <span class="required">*</span></label><input type="text" name="prevNameFull[]" class="input" required></div>
                <div class="field"><label class="field-label">Date from <span class="required">*</span></label><input type="date" name="prevNameStart[]" class="input" required></div>
                <div class="field"><label class="field-label">Date to <span class="required">*</span></label><input type="date" name="prevNameEnd[]" class="input" required></div>
            </div>
        `, 'addPreviousName');

        // Right to work Warning Logic
        const rightToWorkSelect = document.querySelector('[name="personal-right_to_work_status"]'); // Use name attribute to target Django widget
        if (rightToWorkSelect) {
            rightToWorkSelect.addEventListener('change', function() {
                const info = document.getElementById('rightToWorkInfo');
                 const val = this.value;
                 if (info) info.classList.toggle('hidden', val !== 'Visa / Work Permit');
            });
        }

        // Local Authority Search Implementation
        const authorities = [
            "Barking and Dagenham", "Barnet", "Barnsley", "Bath and North East Somerset", "Bedford", "Bexley", "Birmingham", "Blackburn with Darwen", "Blackpool", "Bolton", "Bournemouth, Christchurch and Poole", "Bracknell Forest", "Bradford", "Brent", "Brighton and Hove", "Bristol", "Bromley", "Buckinghamshire", "Bury", "Calderdale", "Cambridgeshire", "Camden", "Central Bedfordshire", "Cheshire East", "Cheshire West and Chester", "City of London", "Cornwall", "Coventry", "Croydon", "Cumbria", "Darlington", "Derby", "Derbyshire", "Devon", "Doncaster", "Dorset", "Dudley", "Durham", "Ealing", "East Riding of Yorkshire", "East Sussex", "Enfield", "Essex", "Gateshead", "Gloucestershire", "Greenwich", "Hackney", "Halton", "Hammersmith and Fulham", "Hampshire", "Haringey", "Harrow", "Hartlepool", "Havering", "Herefordshire", "Hertfordshire", "Hillingdon", "Hounslow", "Isle of Wight", "Islington", "Kensington and Chelsea", "Kent", "Kingston upon Hull", "Kingston upon Thames", "Kirklees", "Knowsley", "Lambeth", "Lancashire", "Leeds", "Leicester", "Leicestershire", "Lewisham", "Lincolnshire", "Liverpool", "Luton", "Manchester", "Medway", "Merton", "Middlesbrough", "Milton Keynes", "Newcastle upon Tyne", "Newham", "Norfolk", "North East Lincolnshire", "North Lincolnshire", "North Somerset", "North Tyneside", "North Yorkshire", "Northamptonshire", "Northumberland", "Nottingham", "Nottinghamshire", "Oldham", "Oxfordshire", "Peterborough", "Plymouth", "Portsmouth", "Reading", "Redbridge", "Redcar and Cleveland", "Richmond upon Thames", "Rochdale", "Rotherham", "Rutland", "Salford", "Sandwell", "Sefton", "Sheffield", "Shropshire", "Slough", "Solihull", "Somerset", "South Gloucestershire", "South Tyneside", "Southampton", "Southend-on-Sea", "Southwark", "St Helens", "Staffordshire", "Stockport", "Stockton-on-Tees", "Stoke-on-Trent", "Suffolk", "Sunderland", "Surrey", "Sutton", "Swindon", "Tameside", "Telford and Wrekin", "Thurrock", "Torbay", "Tower Hamlets", "Trafford", "Wakefield", "Walsall", "Waltham Forest", "Wandsworth", "Warrington", "Warwickshire", "West Berkshire", "West Sussex", "Westminster", "Wigan", "Wiltshire", "Windsor and Maidenhead", "Wirral", "Wokingham", "Wolverhampton", "Worcestershire", "York"
        ];

        const authoritySearch = document.getElementById('authoritySearch');
        const authorityResults = document.getElementById('authorityResults');
        let highlightedIndex = -1;

        if (authoritySearch && authorityResults) {
            authoritySearch.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                authorityResults.innerHTML = '';
                highlightedIndex = -1;

                if (!query) {
                    authorityResults.classList.remove('active');
                    return;
                }

                const matches = authorities.filter(a => a.toLowerCase().includes(query))
                    .sort((a, b) => {
                        const aStart = a.toLowerCase().startsWith(query);
                        const bStart = b.toLowerCase().startsWith(query);
                        if (aStart && !bStart) return -1;
                        if (!aStart && bStart) return 1;
                        return a.localeCompare(b);
                    })
                    .slice(0, 10);

                if (matches.length > 0) {
                    matches.forEach(match => {
                        const div = document.createElement('div');
                        div.className = 'search-item';
                        
                        // Highlight match
                        const matchIndex = match.toLowerCase().indexOf(query);
                        const before = match.substring(0, matchIndex);
                        const middle = match.substring(matchIndex, matchIndex + query.length);
                        const after = match.substring(matchIndex + query.length);
                        div.innerHTML = `${before}<span class="match">${middle}</span>${after}`;
                        
                        div.addEventListener('click', () => selectAuthority(match));
                        authorityResults.appendChild(div);
                    });
                    authorityResults.classList.add('active');
                } else {
                    authorityResults.classList.remove('active');
                }
            });

            authoritySearch.addEventListener('keydown', function(e) {
                const items = authorityResults.querySelectorAll('.search-item');
                if (!authorityResults.classList.contains('active')) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    highlightedIndex = (highlightedIndex + 1) % items.length;
                    updateHighlight(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    highlightedIndex = (highlightedIndex - 1 + items.length) % items.length;
                    updateHighlight(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (highlightedIndex >= 0) {
                        selectAuthority(items[highlightedIndex].textContent);
                    }
                } else if (e.key === 'Escape') {
                    authorityResults.classList.remove('active');
                }
            });

            // Close when clicking outside
            document.addEventListener('click', (e) => {
                if (!authoritySearch.contains(e.target) && !authorityResults.contains(e.target)) {
                    authorityResults.classList.remove('active');
                }
            });

            // Enforce selection from list
            authoritySearch.addEventListener('blur', function() {
                setTimeout(() => {
                    const val = this.value.trim();
                    if (val && !authorities.some(a => a === val)) {
                        this.value = '';
                        this.classList.add('error');
                    } else if (val) {
                        this.classList.remove('error');
                    }
                }, 200); // Small delay to allow click event on results to fire first
            });
        }

        function updateHighlight(items) {
            items.forEach((item, idx) => {
                item.classList.toggle('highlighted', idx === highlightedIndex);
                if (idx === highlightedIndex) item.scrollIntoView({ block: 'nearest' });
            });
        }

        function selectAuthority(name) {
            authoritySearch.value = name;
            authorityResults.innerHTML = '';
            authorityResults.classList.remove('active');
        }


        // Simple Capacity Calculation
        function updateCapacity() {
            const assistantsInput = document.querySelector('[name="service-number_of_assistants"]');
            const assistants = assistantsInput ? parseInt(assistantsInput.value || 0) : 0;
            const adults = 1 + assistants;
            
            const tA = document.getElementById('totalAdultsText');
            if (tA) tA.textContent = adults;
            const mU5 = document.getElementById('maxUnder5Text');
            if (mU5) mU5.textContent = adults * 3;
            const mU1 = document.getElementById('maxUnder1Text');
            if (mU1) mU1.textContent = adults;
            const mU8 = document.getElementById('maxUnder8Text');
            if (mU8) mU8.textContent = adults * 6;
        }

        document.querySelector('[name="service-number_of_assistants"]')?.addEventListener('input', updateCapacity);
        document.querySelectorAll('[name="service-work_with_assistants"]').forEach(el => el.addEventListener('change', updateCapacity));
        updateCapacity();

        // Show error summary if backend errors exist
        if (document.querySelector('.field-error, .errorlist')) {
            const summary = document.querySelector('.error-summary');
            if (summary) {
                const errorSections = new Set();
                document.querySelectorAll('.field-error, .errorlist').forEach(err => {
                    const section = err.closest('.form-section');
                    if (section) {
                        const title = section.querySelector('.section-title')?.textContent || `Section ${parseInt(section.id.split('-')[1]) + 1}`;
                        errorSections.add(title);
                    }
                });
                
                let listHtml = "";
                if (errorSections.size > 0) {
                    listHtml = `<ul style="margin-top: 10px; padding-left: 20px; list-style: disc;">` + 
                        Array.from(errorSections).map(s => `<li>${s}</li>`).join('') + 
                        `</ul>`;
                }

                summary.innerHTML = `
                    <div class="error-summary-header">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y1="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                        <h3>There is a problem</h3>
                    </div>
                    <p>Please check the following sections for errors:</p>
                    ${listHtml}
                `;
                summary.classList.add('active');
            }
        }


        // Listen on the entire address section for dynamically-added date inputs
        const addressSection = document.getElementById('section-1');
        if (addressSection) {
            addressSection.addEventListener('change', (e) => {
                if (e.target.name && e.target.name.endsWith('-move_in_date')) {
                    updateAddressHistory();
                }
            });
        }
        updateAddressHistory();
        
        // Auto-switch to first section with errors on page load
        const firstErrorField = document.querySelector('.field-error, .errorlist, .error-summary.active');
        if (firstErrorField) {
            const section = firstErrorField.closest('.form-section');
            if (section) {
                const sectionId = section.id;
                const sectionIndex = parseInt(sectionId.split('-')[1]);
                if (!isNaN(sectionIndex)) {
                    showSection(sectionIndex);
                }
            }
        }

        updateProgress();
    })();
</script>
{% endblock %}